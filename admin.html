<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الإدارة - نظام أبو حذيفة</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --dark-blue: #0d1b2a;
            --medium-blue: #1b263b;
            --light-blue: #3d5a80;
            --accent: #ee6c4d;
            --text-light: #e0e1dd;
            --text-dark: #293241;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .navbar {
            background-color: var(--dark-blue);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar .logo img {
            height: 40px;
            filter: brightness(0) invert(1);
        }

        .navbar h2 {
            font-weight: 700;
            font-size: 1.3rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .logout-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #d85a3c;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: var(--light-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn:hover,
        .tab-btn.active {
            background: var(--dark-blue);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-blue);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--light-blue);
        }

        button {
            background-color: var(--dark-blue);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--medium-blue);
        }

        .btn-primary {
            background-color: var(--accent);
        }

        .btn-primary:hover {
            background-color: #d85a3c;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        table th,
        table td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        table th {
            background-color: var(--dark-blue);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            font-family: inherit;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--light-blue);
        }

        .report-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
        }

        .card h4 {
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .card p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            animation: slideIn 0.4s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--accent);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .tabs {
                justify-content: center;
            }

            .container {
                padding: 0 0.5rem;
            }

            .tab-content {
                padding: 1rem;
            }

            table th,
            table td {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .report-cards {
                grid-template-columns: 1fr;
            }
        }

        .success {
            color: #2a9d8f;
            font-weight: 600;
            margin-top: 1rem;
        }

        .error {
            color: #e63946;
            font-weight: 600;
            margin-top: 1rem;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
            padding: 0.3rem 0.6rem;
            font-size: 0.85rem;
        }

        .btn-delete {
            background: #dc3545;
            padding: 0.3rem 0.6rem;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">
            <img src="https://i.ibb.co/LDSLfqXy/abohuthaifa-logo.png" alt="شعار أبو حذيفة">
        </div>
        <h2>لوحة الإدارة</h2>
        <div class="user-info">
            <span id="userNameDisplay">👑 المدير</span>
            <button class="logout-btn" id="logoutBtn">تسجيل خروج</button>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" data-tab="dailyReport">التقرير اليومي</button>
            <button class="tab-btn" data-tab="manageReceivables">إدارة المستحقات</button>
            <button class="tab-btn" data-tab="agentsPerformance">أداء المندوبين</button>
        </div>

        <!-- تبويب التقرير اليومي -->
        <div id="dailyReport" class="tab-content active">
            <h3>📊 التقرير اليومي</h3>
            <div class="report-cards">
                <div class="card">
                    <h4>إجمالي التحصيل اليومي</h4>
                    <p id="totalCollection">0 ريال</p>
                </div>
                <div class="card">
                    <h4>إجمالي الإيداعات</h4>
                    <p id="totalDeposits">0 ريال</p>
                </div>
                <div class="card">
                    <h4>إجمالي النثريات</h4>
                    <p id="totalExpenses">0 ريال</p>
                </div>
                <div class="card">
                    <h4>الرصيد المتبقي</h4>
                    <p id="remainingBalance">0 ريال</p>
                </div>
            </div>

            <button id="exportPDF" class="btn-primary">تصدير كـ PDF</button>

            <h4 style="margin-top: 2rem;">تفصيل التحصيلات اليومية</h4>
            <table id="dailyCollectionsTable">
                <thead>
                    <tr>
                        <th>العميل</th>
                        <th>المبلغ</th>
                        <th>المندوب</th>
                        <th>نوع العملية</th>
                        <th>التاريخ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- سيتم ملؤها تلقائيًا -->
                </tbody>
            </table>
        </div>

        <!-- تبويب إدارة المستحقات -->
        <div id="manageReceivables" class="tab-content">
            <h3>📋 إدارة المستحقات</h3>
            <button id="addReceivableBtn" class="btn-primary">إضافة مستحق جديد</button>
            <input type="text" id="searchReceivableAdmin" class="search-box" placeholder="ابحث عن عميل...">
            <table id="adminReceivablesTable">
                <thead>
                    <tr>
                        <th>اسم العميل</th>
                        <th>المبلغ المستحق</th>
                        <th>تاريخ الاستحقاق</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- سيتم ملؤها تلقائيًا -->
                </tbody>
            </table>
        </div>

        <!-- تبويب أداء المندوبين -->
        <div id="agentsPerformance" class="tab-content">
            <h3>📈 أداء المندوبين</h3>
            <table id="agentsPerformanceTable">
                <thead>
                    <tr>
                        <th>اسم المندوب</th>
                        <th>إجمالي التحصيل</th>
                        <th>إجمالي الإيداعات</th>
                        <th>إجمالي النثريات</th>
                        <th>الرصيد المتبقي</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- سيتم ملؤها تلقائيًا -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal إضافة مستحق جديد -->
    <div id="addReceivableModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>إضافة مستحق جديد</h2>
            <form id="addReceivableForm">
                <div class="form-group">
                    <label for="newClient">اسم العميل</label>
                    <input type="text" id="newClient" required list="clientList">
                    <datalist id="clientList">
                        <!-- سيتم ملؤها تلقائيًا -->
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="newAmount">المبلغ المستحق</label>
                    <input type="number" id="newAmount" required min="1">
                </div>
                <div class="form-group">
                    <label for="newDueDate">تاريخ الاستحقاق</label>
                    <input type="date" id="newDueDate" required>
                </div>
                <div class="form-group">
                    <label for="newStatus">الحالة</label>
                    <select id="newStatus" required>
                        <option value="مفتوح">مفتوح</option>
                        <option value="مسوّى">مسوّى</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newNotes">ملاحظات</label>
                    <textarea id="newNotes" rows="3"></textarea>
                </div>
                <button type="submit">إضافة المستحق</button>
                <div id="addReceivableMessage" class="success"></div>
            </form>
        </div>
    </div>

    <script>
        // بيانات العملاء من ملف حسابات.xlsx
        const CLIENTS = [
            "بلال محمد عبدالله علي الوصابي",
            "حسام علي عبد الغني امين الفاتكي",
            "عقيل عبدالعزيز علي احمد",
            "عبدالله غالب علي عبدالله",
            "هاشم عبدالرحمن هاشم عبدالله",
            "سامي عبدالله سالم صالح",
            "اسامة يوسف ابراهيم السلمي",
            "علي صالح مثنى عثمان",
            "عبدالله عبدالاله عبده احمد",
            "عبدالله عبده محمد حسن الحمادي",
            "وليد محمد عبده قائد الحداد",
            "احمد علي محسن منصور",
            "وسيم علي حميد عبدالله",
            "ياسين طه سعيد محمد قائد",
            "محمد حسين صالح منصور قلعوب",
            "هيثم احمد علي عبدالعزيز",
            "صلاح مهيوب سلام سيف الحمادي",
            "مصلح احمد حسين العنبي",
            "علي قايد علي الشميري",
            "علي محمد عوض الحداد المصعبي",
            "حسن عبدالغني علي محمد",
            "فهد طه محمد مصلح احمد",
            "عبدالسلام عبدالله علي الرعيني",
            "بسام عبده ثابت الصلوي",
            "بسام حفظ الله عبدالله العماد",
            "رياض محمود سيف فارع",
            "علاء ابوالقاسم يحيى محمد القعيش",
            "عمر حميد علي احمد",
            "وسام ناصر حزام جراده",
            "وليد احمد فتح الله عقيه",
            "عدي طه محمد مصلح",
            "فتح محمد محمد السمحي",
            "عبدالله احمد محمد عساج",
            "شمسان محمد عبدالله الدحملي",
            "نجم الدين محمد ديوان خالد",
            "مركز الاحمدي للجوالات الذكية",
            "محمد يحيى ناصر قاسم",
            "عدنان عبدالله سعيد محمد العامري",
            "يونس عبده صالح العمري",
            "انور عبد احمد الصغير",
            "عبدالناصر محمد عبدالله شرف",
            "محمد امين محمد عبدالرب",
            "غازي عبده اسماعيل المنتصر",
            "قابوس فرحان مرشد محمد",
            "مؤسسة روابي للمقاولات العامه",
            "عمار علي شوعي زوعان",
            "يوسف عبدربه احمد يوسف",
            "حساب وسيط قيود",
            "جمال جميل عبدالله مغلس قاسم",
            "سلطان عبدالله قاسم محمد",
            "محمد سعيد احمد ابراهيم",
            "نجم الدين سمير عبده حسن الخولاني",
            "علاء محمد علي حسن المعلمي",
            "محسن صالح علي سعيد لسود",
            "محمد علي احمد غالب الشراعي",
            "عاصم خالد عبدالله محسن سهيل",
            "علي محمد علي السليماني",
            "هايل علي صالح علي الشلوف",
            "طه محمد حسين المشيرعي",
            "رعد علي احمد شامي",
            "تحصيل وتساليم ظهران",
            "جميل محمد احمد سعيد",
            "حمدي رزق محمد مصلح شطيف",
            "فؤاد احمد عبدالحميد السيد",
            "بشير عبده سيف الحكمي",
            "مجد عبدالرحيم علي علي الشعيبي",
            "رشيد عبدالله حسن الريمي",
            "اوسان عبدالباقي علي ناجي القدسي",
            "صدام حسين حسين جبار",
            "المنذر عبدالحميد محمد عبدالله الوصابي",
            "عبدالله صالح صالح غراد",
            "محمد درهم يحيى المعيضي",
            "حافظ حسن علي حمود الشهاري",
            "قصي طه محمد مصلح العواضي",
            "ابو بكر سالم يحيى قاسم بعيصي",
            "نواف امين علي محمد النظاري",
            "عبدالعزيز محمد عبدالله علي الوصابي",
            "مالك احمد عبدالله علي الوصابي",
            "عبداللطيف محمد عبدالله علي الوصابي",
            "بشار محمد ابوالقاسم يحيى القعيش",
            "حبيب عبداللطيف محمد عبدالله الوصابي",
            "صلاح محمد قائد حمود الخياط",
            "محمد راجح يحيى قاسم راجح",
            "محمد امين علي النظاري",
            "محمد عبدالحميد محمد عبدالله الوصابي",
            "نور الدين محمد سعدالله يحيى راجح",
            "هجرس كمال احمد عبدالله"
        ];

        // بيانات المستحقات والتحصيلات والإخلاءات (تخزين محلي)
        let receivables = JSON.parse(localStorage.getItem('receivables')) || [];
        let collections = JSON.parse(localStorage.getItem('collections')) || [];
        let clearances = JSON.parse(localStorage.getItem('clearances')) || [];

        // حفظ البيانات
        function saveData() {
            localStorage.setItem('receivables', JSON.stringify(receivables));
            localStorage.setItem('collections', JSON.stringify(collections));
            localStorage.setItem('clearances', JSON.stringify(clearances));
        }

        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من تسجيل الدخول
            const user = localStorage.getItem('loggedInUser');
            if (!user || user !== 'admin') {
                window.location.href = 'index.html';
                return;
            }

            // تسجيل الخروج
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('loggedInUser');
                window.location.href = 'index.html';
            });

            // تبديل التبويبات
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                });
            });

            // تحميل التقرير اليومي
            loadDailyReport();

            // تحميل المستحقات في لوحة الإدارة
            loadAdminReceivables();

            // تحميل أداء المندوبين
            loadAgentsPerformance();

            // إعداد قائمة العملاء في datalist
            const clientList = document.getElementById('clientList');
            CLIENTS.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                clientList.appendChild(option);
            });

            // فتح Modal إضافة مستحق جديد
            document.getElementById('addReceivableBtn').addEventListener('click', function() {
                document.getElementById('addReceivableModal').style.display = 'block';
            });

            // إغلاق Modal
            document.querySelector('.close').addEventListener('click', function() {
                document.getElementById('addReceivableModal').style.display = 'none';
                document.getElementById('addReceivableForm').reset();
                document.getElementById('addReceivableMessage').textContent = '';
            });

            window.addEventListener('click', function(event) {
                const modal = document.getElementById('addReceivableModal');
                if (event.target == modal) {
                    modal.style.display = 'none';
                    document.getElementById('addReceivableForm').reset();
                    document.getElementById('addReceivableMessage').textContent = '';
                }
            });

            // إضافة مستحق جديد
            document.getElementById('addReceivableForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const client = document.getElementById('newClient').value.trim();
                const amount = parseFloat(document.getElementById('newAmount').value);
                const dueDate = document.getElementById('newDueDate').value;
                const status = document.getElementById('newStatus').value;
                const notes = document.getElementById('newNotes').value;

                if (!client || client === '') {
                    document.getElementById('addReceivableMessage').textContent = '❌ يرجى إدخال اسم عميل صالح';
                    return;
                }

                if (isNaN(amount) || amount <= 0) {
                    document.getElementById('addReceivableMessage').textContent = '❌ يرجى إدخال مبلغ صالح';
                    return;
                }

                if (!dueDate) {
                    document.getElementById('addReceivableMessage').textContent = '❌ يرجى اختيار تاريخ استحقاق';
                    return;
                }

                // إضافة المستحق الجديد
                const newReceivable = {
                    id: Date.now(),
                    client,
                    amount,
                    dueDate,
                    status,
                    notes,
                    agent: 'admin' // أضيف بواسطة الإدارة
                };
                receivables.push(newReceivable);

                // حفظ البيانات
                saveData();

                // إعادة تعيين النموذج
                this.reset();
                document.getElementById('addReceivableMessage').textContent = '✅ تم إضافة المستحق بنجاح!';
                setTimeout(() => {
                    document.getElementById('addReceivableModal').style.display = 'none';
                    document.getElementById('addReceivableMessage').textContent = '';
                }, 2000);

                // تحديث عرض المستحقات
                loadAdminReceivables();
            });

            // البحث في المستحقات
            document.getElementById('searchReceivableAdmin').addEventListener('input', function() {
                filterAdminReceivables(this.value);
            });

            // تصدير التقرير كـ PDF
            document.getElementById('exportPDF').addEventListener('click', function() {
                exportReportToPDF();
            });
        });

        function loadDailyReport() {
            const today = new Date().toISOString().split('T')[0];
            const todayCollections = collections.filter(c => c.date === today);
            const todayClearances = clearances.filter(c => c.date === today);

            const totalCollection = todayCollections.reduce((sum, c) => sum + c.amount, 0);
            const totalDeposits = todayClearances
                .filter(c => c.type === 'إيداع بنكي')
                .reduce((sum, c) => sum + c.amount, 0);
            const totalExpenses = todayClearances
                .filter(c => c.type === 'نثريات')
                .reduce((sum, c) => sum + c.amount, 0);
            const remainingBalance = totalCollection - (totalDeposits + totalExpenses);

            // عرض التقرير
            document.getElementById('totalCollection').textContent = `${totalCollection.toLocaleString()} ريال`;
            document.getElementById('totalDeposits').textContent = `${totalDeposits.toLocaleString()} ريال`;
            document.getElementById('totalExpenses').textContent = `${totalExpenses.toLocaleString()} ريال`;
            document.getElementById('remainingBalance').textContent = `${remainingBalance.toLocaleString()} ريال`;

            // تفصيل التحصيلات اليومية
            const tableBody = document.querySelector('#dailyCollectionsTable tbody');
            tableBody.innerHTML = '';

            todayCollections.forEach(collection => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${collection.client}</td>
                    <td>${collection.amount.toLocaleString()} ريال</td>
                    <td>${collection.agent}</td>
                    <td>${collection.operationType}</td>
                    <td>${collection.date}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadAdminReceivables() {
            const tableBody = document.querySelector('#adminReceivablesTable tbody');
            tableBody.innerHTML = '';

            receivables.forEach((receivable, index) => {
                const row = document.createElement('tr');
                
                // تطبيق الألوان حسب التاريخ
                const dueDate = new Date(receivable.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (dueDate < today) {
                    row.classList.add('overdue');
                } else if (dueDate.getTime() === today.getTime()) {
                    row.classList.add('due-today');
                }

                row.innerHTML = `
                    <td>${receivable.client}</td>
                    <td>${receivable.amount.toLocaleString()} ريال</td>
                    <td>${receivable.dueDate}</td>
                    <td>${receivable.status}</td>
                    <td class="actions">
                        <button class="btn-edit" onclick="editReceivableAdmin(${index})">تعديل</button>
                        <button class="btn-delete" onclick="deleteReceivableAdmin(${index})">حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function filterAdminReceivables(searchTerm) {
            const tableBody = document.querySelector('#adminReceivablesTable tbody');
            tableBody.innerHTML = '';

            const filtered = receivables.filter(r => 
                r.client.toLowerCase().includes(searchTerm.toLowerCase())
            );

            filtered.forEach((receivable, index) => {
                const row = document.createElement('tr');
                
                const dueDate = new Date(receivable.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (dueDate < today) {
                    row.classList.add('overdue');
                } else if (dueDate.getTime() === today.getTime()) {
                    row.classList.add('due-today');
                }

                row.innerHTML = `
                    <td>${receivable.client}</td>
                    <td>${receivable.amount.toLocaleString()} ريال</td>
                    <td>${receivable.dueDate}</td>
                    <td>${receivable.status}</td>
                    <td class="actions">
                        <button class="btn-edit" onclick="editReceivableAdmin(${index})">تعديل</button>
                        <button class="btn-delete" onclick="deleteReceivableAdmin(${index})">حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadAgentsPerformance() {
            const agents = ["شمسان محمد", "علاء المعلمي", "المنذر الوصابي", "مالك الوصابي"];
            const tableBody = document.querySelector('#agentsPerformanceTable tbody');
            tableBody.innerHTML = '';

            agents.forEach(agent => {
                const agentCollections = collections.filter(c => c.agent === agent);
                const agentClearances = clearances.filter(c => c.agent === agent);
                
                const totalCollection = agentCollections.reduce((sum, c) => sum + c.amount, 0);
                const totalDeposits = agentClearances
                    .filter(c => c.type === 'إيداع بنكي')
                    .reduce((sum, c) => sum + c.amount, 0);
                const totalExpenses = agentClearances
                    .filter(c => c.type === 'نثريات')
                    .reduce((sum, c) => sum + c.amount, 0);
                const remainingBalance = totalCollection - (totalDeposits + totalExpenses);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${agent}</td>
                    <td>${totalCollection.toLocaleString()} ريال</td>
                    <td>${totalDeposits.toLocaleString()} ريال</td>
                    <td>${totalExpenses.toLocaleString()} ريال</td>
                    <td>${remainingBalance.toLocaleString()} ريال</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function editReceivableAdmin(index) {
            const receivable = receivables[index];
            const newAmount = prompt('أدخل المبلغ المستحق الجديد:', receivable.amount);
            if (newAmount !== null && !isNaN(newAmount) && parseFloat(newAmount) >= 0) {
                receivable.amount = parseFloat(newAmount);
                receivable.status = parseFloat(newAmount) > 0 ? 'مفتوح' : 'مسوّى';
                saveData();
                loadAdminReceivables();
                alert('✅ تم تحديث المستحق بنجاح!');
            }
        }

        function deleteReceivableAdmin(index) {
            if (confirm('هل أنت متأكد أنك تريد حذف هذا المستحق؟')) {
                receivables.splice(index, 1);
                saveData();
                loadAdminReceivables();
                alert('✅ تم حذف المستحق بنجاح!');
            }
        }

        function exportReportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.text("تقرير يومي - نظام أبو حذيفة", 105, 20, { align: "center" });
            
            doc.setFontSize(12);
            doc.text(`تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}`, 20, 35);
            
            const today = new Date().toISOString().split('T')[0];
            const todayCollections = collections.filter(c => c.date === today);
            const todayClearances = clearances.filter(c => c.date === today);

            const totalCollection = todayCollections.reduce((sum, c) => sum + c.amount, 0);
            const totalDeposits = todayClearances
                .filter(c => c.type === 'إيداع بنكي')
                .reduce((sum, c) => sum + c.amount, 0);
            const totalExpenses = todayClearances
                .filter(c => c.type === 'نثريات')
                .reduce((sum, c) => sum + c.amount, 0);
            const remainingBalance = totalCollection - (totalDeposits + totalExpenses);

            let yPos = 50;
            doc.setFont("helvetica", "bold");
            doc.text("الملخص المالي", 20, yPos);
            yPos += 10;
            doc.setFont("helvetica", "normal");
            doc.text(`إجمالي التحصيل: ${totalCollection.toLocaleString()} ريال`, 20, yPos);
            yPos += 7;
            doc.text(`إجمالي الإيداعات: ${totalDeposits.toLocaleString()} ريال`, 20, yPos);
            yPos += 7;
            doc.text(`إجمالي النثريات: ${totalExpenses.toLocaleString()} ريال`, 20, yPos);
            yPos += 7;
            doc.text(`الرصيد المتبقي: ${remainingBalance.toLocaleString()} ريال`, 20, yPos);

            yPos += 15;
            doc.setFont("helvetica", "bold");
            doc.text("تفصيل التحصيلات", 20, yPos);
            yPos += 10;

            todayCollections.forEach(collection => {
                doc.setFont("helvetica", "normal");
                doc.text(`${collection.client} - ${collection.amount.toLocaleString()} ريال - ${collection.agent}`, 20, yPos);
                yPos += 7;
                if (yPos > 280) {
                    doc.addPage();
                    yPos = 20;
                }
            });

            doc.save(`تقرير_يومي_أبو_حذيفة_${new Date().toISOString().split('T')[0]}.pdf`);
            alert('✅ تم تصدير التقرير كـ PDF بنجاح!');
        }
    </script>
</body>
</html>
