<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام أبو حذيفة للصرافة والتحويلات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --primary-lighter: #60a5fa;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --purple: #8b5cf6;
            --teal: #14b8a6;
            --indigo: #6366f1;
            --pink: #ec4899;
        }
        
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 50%, var(--primary-lighter) 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .tab-button {
            transition: all 0.3s ease;
            border-radius: 12px;
            font-weight: 600;
        }

        .tab-button.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
        }

        .tab-button:hover:not(.active) {
            background: rgba(59, 130, 246, 0.1);
        }

        .input-field {
            transition: all 0.3s ease;
            border-radius: 10px;
        }

        .input-field:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            border-color: var(--primary-light);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            transition: all 0.3s ease;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 64, 175, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2563eb 0%, var(--primary-lighter) 100%);
            transition: all 0.3s ease;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .operation-card {
            transition: all 0.3s ease;
            animation: slideIn 0.4s ease;
            border-right: 4px solid transparent;
        }

        .operation-card:hover {
            transform: translateX(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            border-right-color: var(--primary-light);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);
            border-right: 4px solid var(--primary-light);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.08);
            transition: all 0.3s ease;
            border-radius: 12px;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.15);
        }

        .loading-spinner {
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top: 3px solid var(--primary-light);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.4s ease;
            z-index: 1000;
            font-weight: 600;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(6px);
        }

        .progress-bar {
            transition: width 0.6s ease;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 50%, var(--primary-lighter) 100%);
            border-radius: 10px;
        }

        .icon-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .modern-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }

        .header-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin: 5px 0 0 0;
        }

        .user-info {
            text-align: left;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .date-display {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .agent-display {
            font-size: 1rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .card-modern {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: none;
        }

        .card-modern:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            color: white;
            padding: 15px 20px;
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* تحسين ألوان البطاقات لتتناسب مع التصميم العام */
        .collection-card .card-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
        }

        .deposit-card .card-header {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-lighter));
        }

        .expense-card .card-header {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
        }

        .transfer-card .card-header {
            background: linear-gradient(135deg, #1d4ed8, #2563eb);
        }

        .card-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .nav-tabs {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding: 10px 0;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.1);
        }

        .share-template {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            white-space: pre-line;
            max-height: 60vh;
            overflow-y: auto;
        }

        .share-header {
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 10px;
        }

        .share-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .share-label {
            font-weight: 600;
            color: #4b5563;
        }

        .share-value {
            font-weight: 700;
            color: var(--primary);
        }

        .share-total {
            background: #eff6ff;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 700;
            text-align: center;
            color: var(--primary);
            border: 1px solid #bfdbfe;
        }

        .region-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .region-tab {
            padding: 10px 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .region-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }

        .region-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.1);
        }

        .region-section {
            display: none;
        }

        .region-section.active {
            display: block;
        }

        /* تحسينات جديدة للاستجابة */
        .filter-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .data-entry-bg {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        /* تحسينات للشاشات المنبثقة لتكون متجاوبة */
        .responsive-modal {
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }

        /* تحسينات جديدة */
        .last-deposits {
            border-top: 1px solid #e5e7eb;
            margin-top: 15px;
            padding-top: 15px;
        }

        .deposit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .deposit-item:last-child {
            border-bottom: none;
        }

        .search-input {
            width: 100%;
            margin-bottom: 15px;
        }

        .debtor-select {
            margin-bottom: 10px;
        }

        .remaining-debt {
            background-color: #fef3c7;
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 10px;
            font-weight: 600;
            color: #92400e;
            text-align: center;
        }

        /* تحسينات القوائم المنسدلة للبحث */
        .searchable-select {
            position: relative;
        }

        .searchable-select input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
        }

        .searchable-select .options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .searchable-select .option {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }

        .searchable-select .option:hover {
            background-color: #f1f5f9;
        }

        .searchable-select .option:last-child {
            border-bottom: none;
        }

        /* تحسينات لعرض بيانات العملاء المديونين */
        .debtor-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .debtor-stat-item {
            background: #f8fafc;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .debtor-stat-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 5px;
        }

        .debtor-stat-value {
            font-size: 16px;
            font-weight: bold;
        }

        .debt-due {
            color: #ef4444;
        }

        .debt-collected {
            color: #10b981;
        }

        .debt-remaining {
            color: #f59e0b;
        }

        /* تحسينات لتبويب الملخص اليومي */
        .operations-category {
            margin-bottom: 30px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .category-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* تحسينات للأحجام على الشاشات الصغيرة */
        .responsive-stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .responsive-operation-card {
            flex-direction: column;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .glass-card {
                border-radius: 12px;
            }
            
            .tab-button, .nav-tab {
                font-size: 0.813rem;
                padding: 0.5rem 0.75rem;
            }
            
            .stat-card {
                padding: 0.75rem;
            }
            
            .operation-card {
                flex-direction: column;
                gap: 0.75rem;
                align-items: start;
            }
            
            .operation-card > div:last-child {
                width: 100%;
                text-align: right;
            }

            .icon-circle {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .header-title {
                font-size: 1.4rem;
            }

            .logo {
                width: 50px;
                height: 50px;
            }

            .filter-group {
                min-width: 100%;
            }

            .filter-row {
                flex-direction: column;
            }

            .responsive-modal {
                width: 95%;
                margin: 10px;
            }

            .debtor-stats {
                grid-template-columns: 1fr;
            }

            /* تحسينات إضافية للملخص اليومي */
            .responsive-stat-grid {
                grid-template-columns: 1fr 1fr;
            }

            .category-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .responsive-operation-card {
                padding: 15px;
            }

            .operations-category {
                margin-bottom: 20px;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                font-size: 1.2rem;
            }
            
            .card-modern {
                margin-bottom: 15px;
            }
            
            .nav-tab {
                padding: 10px 15px;
                font-size: 0.75rem;
            }

            .responsive-modal {
                width: 98%;
                margin: 5px;
            }

            .responsive-stat-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen">
        <!-- Modern Header -->
        <header class="modern-header">
            <div class="container mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="logo-container">
                        <img src="https://i.ibb.co/whLbwk4s/20250730-012920.png" alt="أبو حذيفة" class="logo">
                        <div>
                            <h1 class="header-title">نظام إدارة التحصيلات والإيداعات</h1>
                            <p class="header-subtitle">أبو حذيفة للصرافة والتحويلات</p>
                        </div>
                    </div>
                    <div class="user-info">
                        <p class="date-display" id="current-date"></p>
                        <p class="agent-display" id="current-agent">المستخدم: غير محدد</p>
                        <button id="logout-btn" class="mt-2 bg-white text-red-600 px-4 py-1.5 rounded-lg text-sm font-semibold hover:bg-red-50 transition w-full">
                            <i class="fas fa-sign-out-alt ml-1"></i> تسجيل خروج
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Login Screen -->
        <div id="login-screen" class="glass-card mx-4 my-6 p-8 max-w-md mx-auto">
            <div class="text-center mb-6">
                <div class="icon-circle mx-auto mb-4" style="background: linear-gradient(135deg, var(--primary), var(--primary-light)); width: 80px; height: 80px;">
                    <img src="https://i.ibb.co/whLbwk4s/20250730-012920.png" alt="أبو حذيفة" class="w-16 h-16 rounded-full object-cover">
                </div>
                <h2 class="text-3xl font-bold text-blue-900">تسجيل الدخول</h2>
            </div>
            <form id="login-form" class="space-y-4">
                <div class="form-group">
                    <label class="form-label">نوع المستخدم</label>
                    <select id="user-type" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                        <option value="">اختر نوع المستخدم</option>
                        <option value="agent">مندوب</option>
                        <option value="admin">إدارة</option>
                    </select>
                </div>
                <div id="agent-name-field" class="hidden form-group">
                    <label class="form-label">اسم المندوب</label>
                    <input type="text" id="agent-name-input" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" placeholder="أدخل اسمك">
                </div>
                <div id="admin-password-field" class="hidden form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" id="admin-password-input" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" placeholder="أدخل كلمة المرور">
                </div>
                <button type="submit" class="btn-primary w-full text-white py-4 rounded-xl flex items-center justify-center gap-2">
                    <i class="fas fa-sign-in-alt"></i> دخول
                </button>
            </form>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <!-- Navigation Tabs -->
            <div class="glass-card mx-4 my-4 p-3">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-tab="data-entry"><i class="fas fa-edit ml-2"></i> إدخال البيانات</button>
                    <button class="nav-tab" data-tab="daily-summary"><i class="fas fa-chart-bar ml-2"></i> ملخص اليوم</button>
                    <button class="nav-tab" data-tab="bank-accounts"><i class="fas fa-university ml-2"></i> الحسابات البنكية</button>
                    <button class="nav-tab" data-tab="debtor-customers"><i class="fas fa-users ml-2"></i> العملاء المديونين</button>
                    <button class="nav-tab" data-tab="failed-deposits"><i class="fas fa-times-circle ml-2"></i> الإيداعات الفاشلة</button>
                    <button class="nav-tab" data-tab="all-operations"><i class="fas fa-list-alt ml-2"></i> جميع العمليات</button>
                    <button class="nav-tab" data-tab="dashboard"><i class="fas fa-tachometer-alt ml-2"></i> لوحة المعلومات</button>
                    <button class="nav-tab" data-tab="agents"><i class="fas fa-user-tie ml-2"></i> إدارة المندوبين</button>
                </div>
            </div>

            <!-- Data Entry Tab -->
            <div id="data-entry-tab" class="tab-content">
                <div class="data-entry-bg mx-4 my-4">
                    <!-- Date Filter for Data Entry -->
                    <div class="filter-section mb-6">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="form-label">تاريخ الإدخال</label>
                                <input type="date" id="data-entry-date" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                            </div>
                            <button id="apply-data-entry-filter" class="btn-primary text-white px-6 py-3 rounded-xl flex items-center h-fit">
                                <i class="fas fa-filter ml-2"></i> تطبيق الفلتر
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Collections -->
                        <div class="card-modern collection-card">
                            <div class="card-header">
                                <i class="fas fa-money-bill-wave ml-2"></i> التحصيلات
                            </div>
                            <div class="card-body">
                                <form id="collection-form" class="space-y-4">
                                    <input type="hidden" id="collection-edit-id" value="">
                                    <div class="form-group">
                                        <label class="form-label">نوع التحصيل</label>
                                        <select id="collection-type" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                            <option value="">اختر النوع</option>
                                            <option value="نقدي">نقدي</option>
                                            <option value="سحب من بطاقة">سحب من بطاقة</option>
                                        </select>
                                    </div>
                                    <div id="bank-card-select-div" class="hidden form-group">
                                        <label class="form-label">اختر البطاقة البنكية</label>
                                        <select id="collection-bank-card" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                                            <option value="">اختر البطاقة</option>
                                        </select>
                                    </div>
                                    <!-- إضافة اختيار العميل من العملاء المديونين مع البحث -->
                                    <div id="debtor-select-div" class="form-group">
                                        <label class="form-label">اختر العميل من العملاء المديونين (اختياري)</label>
                                        <div class="searchable-select">
                                            <input type="text" id="debtor-search-input" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" placeholder="اكتب اسم العميل للبحث...">
                                            <div id="debtor-search-results" class="options hidden"></div>
                                        </div>
                                        <select id="debtor-select" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none hidden">
                                            <option value="">اختر العميل</option>
                                        </select>
                                    </div>
                                    <div id="customer-name-field" class="form-group">
                                        <label class="form-label">اسم العميل</label>
                                        <input type="text" id="customer-name" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                    </div>
                                    <div id="remaining-debt-div" class="hidden">
                                        <div class="remaining-debt">
                                            المبلغ المتبقي: <span id="remaining-debt-amount">0</span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">المبلغ</label>
                                        <input type="number" id="collection-amount" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="submit" class="btn-primary flex-1 text-white py-3 rounded-xl flex items-center justify-center gap-2">
                                            <span id="collection-btn-text"><i class="fas fa-plus-circle ml-2"></i> إضافة تحصيل</span>
                                            <span id="collection-spinner" class="loading-spinner hidden"></span>
                                        </button>
                                        <button type="button" id="collection-cancel-edit" class="hidden bg-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-400 transition flex-1">إلغاء التعديل</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Deposits -->
                        <div class="card-modern deposit-card">
                            <div class="card-header">
                                <i class="fas fa-university ml-2"></i> الإيداعات
                            </div>
                            <div class="card-body">
                                <form id="deposit-form" class="space-y-4">
                                    <input type="hidden" id="deposit-edit-id" value="">
                                    <div class="form-group">
                                        <label class="form-label">الحساب البنكي</label>
                                        <select id="deposit-bank" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                            <option value="">اختر الحساب</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">المبلغ</label>
                                        <input type="number" id="deposit-amount" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="submit" class="btn-primary flex-1 text-white py-3 rounded-xl flex items-center justify-center gap-2">
                                            <span id="deposit-btn-text"><i class="fas fa-plus-circle ml-2"></i> إضافة إيداع</span>
                                            <span id="deposit-spinner" class="loading-spinner hidden"></span>
                                        </button>
                                        <button type="button" id="deposit-cancel-edit" class="hidden bg-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-400 transition flex-1">إلغاء التعديل</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Expenses -->
                        <div class="card-modern expense-card">
                            <div class="card-header">
                                <i class="fas fa-receipt ml-2"></i> المصروفات
                            </div>
                            <div class="card-body">
                                <form id="expense-form" class="space-y-4">
                                    <input type="hidden" id="expense-edit-id" value="">
                                    <div class="form-group">
                                        <label class="form-label">نوع المصروف</label>
                                        <select id="expense-type" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                            <option value="">اختر النوع</option>
                                            <option value="وقود">وقود</option>
                                            <option value="صيانة">صيانة</option>
                                            <option value="رسوم">رسوم</option>
                                            <option value="أخرى">أخرى</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">المبلغ</label>
                                        <input type="number" id="expense-amount" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">تفاصيل المصروف</label>
                                        <textarea id="expense-details" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" rows="2"></textarea>
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="submit" class="btn-primary flex-1 text-white py-3 rounded-xl flex items-center justify-center gap-2">
                                            <span id="expense-btn-text"><i class="fas fa-plus-circle ml-2"></i> إضافة مصروف</span>
                                            <span id="expense-spinner" class="loading-spinner hidden"></span>
                                        </button>
                                        <button type="button" id="expense-cancel-edit" class="hidden bg-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-400 transition flex-1">إلغاء التعديل</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Receipts & Deliveries - محسن -->
                        <div class="card-modern transfer-card">
                            <div class="card-header">
                                <i class="fas fa-exchange-alt ml-2"></i> الاستلامات والتسليم
                            </div>
                            <div class="card-body">
                                <!-- قسم الاستلام -->
                                <div class="mb-6 pb-4 border-b border-gray-200">
                                    <h4 class="text-lg font-bold text-blue-900 mb-3">الاستلام</h4>
                                    <form id="receipt-form" class="space-y-4">
                                        <input type="hidden" id="receipt-edit-id" value="">
                                        <div class="form-group">
                                            <label class="form-label">نوع الاستلام</label>
                                            <select id="receipt-type" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                                <option value="">اختر النوع</option>
                                                <option value="مندوب">مندوب</option>
                                                <option value="استلام نقدي لصالح شركة">استلام نقدي لصالح شركة</option>
                                            </select>
                                        </div>
                                        <div id="receipt-agent-field" class="form-group">
                                            <label class="form-label">اسم المندوب</label>
                                            <input type="text" id="receipt-agent-name" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" placeholder="اسم المندوب">
                                        </div>
                                        <div id="receipt-company-field" class="hidden form-group">
                                            <label class="form-label">اسم الشركة</label>
                                            <input type="text" id="receipt-company-name" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" placeholder="اسم الشركة">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">المبلغ</label>
                                            <input type="number" id="receipt-amount" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                        </div>
                                        <div class="flex gap-2">
                                            <button type="submit" class="btn-primary flex-1 text-white py-3 rounded-xl flex items-center justify-center gap-2">
                                                <span id="receipt-btn-text"><i class="fas fa-download ml-2"></i> استلام نقدي</span>
                                                <span id="receipt-spinner" class="loading-spinner hidden"></span>
                                            </button>
                                            <button type="button" id="receipt-cancel-edit" class="hidden bg-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-400 transition flex-1">إلغاء التعديل</button>
                                        </div>
                                    </form>
                                </div>

                                <!-- قسم التسليم -->
                                <div>
                                    <h4 class="text-lg font-bold text-blue-900 mb-3">التسليم</h4>
                                    <form id="delivery-form" class="space-y-4">
                                        <input type="hidden" id="delivery-edit-id" value="">
                                        <div class="form-group">
                                            <label class="form-label">نوع التسليم</label>
                                            <select id="delivery-type" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                                <option value="">اختر النوع</option>
                                                <option value="مندوب">مندوب</option>
                                                <option value="تسليم نقدي">تسليم نقدي</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">اسم المستلم</label>
                                            <input type="text" id="delivery-recipient" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">المبلغ</label>
                                            <input type="number" id="delivery-amount" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                                        </div>
                                        <div class="flex gap-2">
                                            <button type="submit" class="btn-primary flex-1 text-white py-3 rounded-xl flex items-center justify-center gap-2">
                                                <span id="delivery-btn-text"><i class="fas fa-upload ml-2"></i> تسليم نقدي</span>
                                                <span id="delivery-spinner" class="loading-spinner hidden"></span>
                                            </button>
                                            <button type="button" id="delivery-cancel-edit" class="hidden bg-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-400 transition flex-1">إلغاء التعديل</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Summary Tab - محسن -->
            <div id="daily-summary-tab" class="tab-content hidden">
                <div class="glass-card mx-4 p-4 md:p-6 my-4">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h3 class="text-2xl font-bold text-blue-900"><i class="fas fa-chart-bar ml-2"></i> ملخص اليوم</h3>
                        <div class="flex gap-3 flex-wrap">
                            <button id="share-summary-btn" class="btn-secondary text-white px-4 md:px-6 py-3 rounded-xl flex items-center">
                                <i class="fas fa-share ml-2"></i> <span class="hidden md:inline">مشاركة الملخص</span>
                            </button>
                            <button id="share-detailed-btn" class="btn-secondary text-white px-4 md:px-6 py-3 rounded-xl flex items-center">
                                <i class="fas fa-file-alt ml-2"></i> <span class="hidden md:inline">مشاركة تفصيلي</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Date Filter -->
                    <div class="filter-section mb-4">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="form-label">التاريخ</label>
                                <input type="date" id="daily-summary-date" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                            </div>
                            <button id="apply-daily-filter" class="btn-primary text-white px-4 md:px-6 py-3 rounded-xl flex items-center h-fit">
                                <i class="fas fa-filter ml-2"></i> <span class="hidden md:inline">تطبيق الفلتر</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Previous Day Balance -->
                    <div class="mb-6">
                        <div class="stat-card p-4">
                            <div class="flex justify-between items-center">
                                <p class="text-base md:text-lg font-bold text-gray-700">الرصيد السابق (أمس)</p>
                                <p class="text-xl md:text-2xl font-bold text-purple-600" id="previous-balance">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistics - محسن -->
                    <div class="responsive-stat-grid gap-3 md:gap-4 mb-6">
                        <div class="stat-card p-4">
                            <p class="text-sm font-bold text-gray-600 mb-2">إجمالي التحصيلات</p>
                            <p class="text-xl md:text-2xl font-bold text-green-600" id="total-collections">0</p>
                        </div>
                        <div class="stat-card p-4">
                            <p class="text-sm font-bold text-gray-600 mb-2">إجمالي الإيداعات</p>
                            <p class="text-xl md:text-2xl font-bold text-blue-600" id="total-deposits">0</p>
                        </div>
                        <div class="stat-card p-4">
                            <p class="text-sm font-bold text-gray-600 mb-2">إجمالي المصروفات</p>
                            <p class="text-xl md:text-2xl font-bold text-red-600" id="total-expenses">0</p>
                        </div>
                        <div class="stat-card p-4">
                            <p class="text-sm font-bold text-gray-600 mb-2">الاستلامات</p>
                            <p class="text-xl md:text-2xl font-bold text-purple-600" id="total-receipts">0</p>
                        </div>
                        <div class="stat-card p-4">
                            <p class="text-sm font-bold text-gray-600 mb-2">التسليمات</p>
                            <p class="text-xl md:text-2xl font-bold text-orange-600" id="total-deliveries">0</p>
                        </div>
                        <div class="stat-card p-4">
                            <p class="text-sm font-bold text-gray-600 mb-2">المبلغ المتبقي</p>
                            <p class="text-xl md:text-2xl font-bold text-indigo-600" id="remaining-balance">0</p>
                        </div>
                    </div>
                    
                    <!-- Operations List - محسن -->
                    <div id="operations-list">
                        <p class="text-center text-gray-500 py-12 text-lg">لا توجد عمليات اليوم</p>
                    </div>
                </div>
            </div>

            <!-- All Operations Tab -->
            <div id="all-operations-tab" class="tab-content hidden">
                <div class="glass-card mx-4 p-6 my-4">
                    <h3 class="text-2xl font-bold text-blue-900 mb-6"><i class="fas fa-list-alt ml-2"></i> جميع العمليات</h3>
                    
                    <!-- Filters -->
                    <div class="filter-section">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="form-label">المندوب</label>
                                <select id="filter-agent" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                                    <option value="">الكل</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">نوع العملية</label>
                                <select id="filter-type" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                                    <option value="">الكل</option>
                                    <option value="collection">تحصيل</option>
                                    <option value="deposit">إيداع</option>
                                    <option value="expense">مصروف</option>
                                    <option value="receipt">استلام</option>
                                    <option value="delivery">تسليم</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">التاريخ</label>
                                <input type="date" id="filter-date" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                            </div>
                            <button id="apply-all-operations-filter" class="btn-primary text-white px-6 py-3 rounded-xl flex items-center h-fit">
                                <i class="fas fa-filter ml-2"></i> تطبيق الفلتر
                            </button>
                        </div>
                    </div>
                    
                    <!-- Operations List -->
                    <div class="space-y-4" id="all-operations-list">
                        <p class="text-center text-gray-500 py-12 text-lg">لا توجد عمليات</p>
                    </div>
                </div>
            </div>

            <!-- Bank Accounts Tab - محسن -->
            <div id="bank-accounts-tab" class="tab-content hidden">
                <div class="glass-card mx-4 p-6 my-4">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-blue-900"><i class="fas fa-university ml-2"></i> الحسابات البنكية</h3>
                        <button id="add-bank-btn" class="btn-primary text-white px-6 py-3 rounded-xl admin-only flex items-center">
                            <i class="fas fa-plus ml-2"></i> إضافة حساب
                        </button>
                    </div>
                    
                    <!-- Date Filter -->
                    <div class="filter-section">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="form-label">التاريخ</label>
                                <input type="date" id="bank-accounts-date" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                            </div>
                            <button id="apply-bank-filter" class="btn-primary text-white px-6 py-3 rounded-xl flex items-center h-fit">
                                <i class="fas fa-filter ml-2"></i> تطبيق الفلتر
                            </button>
                        </div>
                    </div>
                    
                    <div id="bank-accounts-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <p class="text-center text-gray-500 py-12 text-lg col-span-full">لا توجد حسابات بنكية</p>
                    </div>
                </div>
            </div>

            <!-- Debtor Customers Tab - محسن -->
            <div id="debtor-customers-tab" class="tab-content hidden">
                <div class="glass-card mx-4 p-6 my-4">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-blue-900"><i class="fas fa-users ml-2"></i> العملاء المديونين</h3>
                        <button id="add-debtor-btn" class="btn-primary text-white px-6 py-3 rounded-xl admin-only flex items-center">
                            <i class="fas fa-plus ml-2"></i> إضافة عميل
                        </button>
                    </div>
                    
                    <!-- إضافة شريط البحث -->
                    <div class="filter-section mb-4">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="form-label">بحث عن العميل</label>
                                <input type="text" id="debtor-search" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" placeholder="اكتب اسم العميل للبحث...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Region Tabs -->
                    <div class="region-tabs">
                        <div class="region-tab active" data-region="all">الكل</div>
                        <div class="region-tab" data-region="khamis">خميس مشيط</div>
                        <div class="region-tab" data-region="dharan">ظهران الجنوب</div>
                        <div class="region-tab" data-region="other">باقي المناطق</div>
                    </div>
                    
                    <!-- Debtors by Region -->
                    <div id="debtors-all" class="region-section active">
                        <div id="debtors-list" class="space-y-4">
                            <p class="text-center text-gray-500 py-12 text-lg">لا توجد ديون مسجلة</p>
                        </div>
                    </div>
                    
                    <div id="debtors-khamis" class="region-section">
                        <div id="debtors-list-khamis" class="space-y-4">
                            <p class="text-center text-gray-500 py-12 text-lg">لا توجد ديون لعملاء خميس مشيط</p>
                        </div>
                    </div>
                    
                    <div id="debtors-dharan" class="region-section">
                        <div id="debtors-list-dharan" class="space-y-4">
                            <p class="text-center text-gray-500 py-12 text-lg">لا توجد ديون لعملاء ظهران الجنوب</p>
                        </div>
                    </div>
                    
                    <div id="debtors-other" class="region-section">
                        <div id="debtors-list-other" class="space-y-4">
                            <p class="text-center text-gray-500 py-12 text-lg">لا توجد ديون لعملاء باقي المناطق</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Failed Deposits Tab -->
            <div id="failed-deposits-tab" class="tab-content hidden">
                <div class="glass-card mx-4 p-6 my-4">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-blue-900"><i class="fas fa-times-circle ml-2"></i> الإيداعات الفاشلة</h3>
                        <button id="add-failed-btn" class="btn-primary text-white px-6 py-3 rounded-xl flex items-center">
                            <i class="fas fa-plus ml-2"></i> إضافة عملية فاشلة
                        </button>
                    </div>
                    <div id="failed-deposits-list" class="space-y-4">
                        <p class="text-center text-gray-500 py-12 text-lg">لا توجد عمليات فاشلة</p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content hidden">
                <div class="glass-card mx-4 p-6 my-4">
                    <h3 class="text-2xl font-bold text-blue-900 mb-6"><i class="fas fa-tachometer-alt ml-2"></i> لوحة المعلومات</h3>
                    
                    <!-- Date Filter -->
                    <div class="filter-section">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="form-label">التاريخ</label>
                                <input type="date" id="dashboard-date" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                            </div>
                            <button id="apply-dashboard-filter" class="btn-primary text-white px-6 py-3 rounded-xl flex items-center h-fit">
                                <i class="fas fa-filter ml-2"></i> تطبيق الفلتر
                            </button>
                            <button id="reset-day-btn" class="btn-secondary text-white px-6 py-3 rounded-xl flex items-center h-fit">
                                <i class="fas fa-sync-alt ml-2"></i> بدء يوم جديد
                            </button>
                        </div>
                    </div>
                    
                    <!-- Overall Statistics -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="stat-card p-4">
                            <p class="text-sm font-bold text-gray-600 mb-2">إجمالي التحصيلات</p>
                            <p class="text-2xl font-bold text-green-600" id="dash-total-collections">0</p>
                        </div>
                        <div class="stat-card p-4">
                            <p class="text-sm font-bold text-gray-600 mb-2">إجمالي الإيداعات</p>
                            <p class="text-2xl font-bold text-blue-600" id="dash-total-deposits">0</p>
                        </div>
                        <div class="stat-card p-4">
                            <p class="text-sm font-bold text-gray-600 mb-2">إجمالي المصروفات</p>
                            <p class="text-2xl font-bold text-red-600" id="dash-total-expenses">0</p>
                        </div>
                        <div class="stat-card p-4">
                            <p class="text-sm font-bold text-gray-600 mb-2">عدد المندوبين</p>
                            <p class="text-2xl font-bold text-purple-600" id="dash-agents-count">0</p>
                        </div>
                    </div>
                    
                    <!-- Agents Performance -->
                    <div class="mt-6">
                        <h4 class="text-xl font-bold text-blue-900 mb-4">أداء المندوبين</h4>
                        <div id="agents-performance" class="space-y-4">
                            <p class="text-center text-gray-500 py-12 text-lg">لا توجد بيانات</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agents Management Tab -->
            <div id="agents-tab" class="tab-content hidden">
                <div class="glass-card mx-4 p-6 my-4">
                    <h3 class="text-2xl font-bold text-blue-900 mb-6"><i class="fas fa-user-tie ml-2"></i> إدارة المندوبين</h3>
                    
                    <!-- Date Filter -->
                    <div class="filter-section">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="form-label">التاريخ</label>
                                <input type="date" id="agents-date" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                            </div>
                            <button id="apply-agents-filter" class="btn-primary text-white px-6 py-3 rounded-xl flex items-center h-fit">
                                <i class="fas fa-filter ml-2"></i> تطبيق الفلتر
                            </button>
                        </div>
                    </div>
                    
                    <div id="agents-list" class="space-y-4">
                        <p class="text-center text-gray-500 py-12 text-lg">لا توجد بيانات</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Bank Account Modal -->
    <div id="bank-modal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="glass-card p-6 responsive-modal">
            <h3 class="text-xl font-bold text-blue-900 mb-4 flex items-center">
                <i class="fas fa-university ml-2"></i> <span id="bank-modal-title">إضافة حساب بنكي</span>
            </h3>
            <form id="bank-form" class="space-y-4">
                <input type="hidden" id="bank-edit-id" value="">
                <div class="form-group">
                    <label class="form-label">اسم الحساب</label>
                    <input type="text" id="bank-name" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                </div>
                <div class="form-group">
                    <label class="form-label">رقم الحساب</label>
                    <input type="text" id="bank-account-number" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                </div>
                <div class="form-group">
                    <label class="form-label">رقم البطاقة</label>
                    <input type="text" id="bank-card-number" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                </div>
                <div class="form-group">
                    <label class="form-label">اسم صاحب البطاقة</label>
                    <input type="text" id="bank-card-holder" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                </div>
                <div class="form-group">
                    <label class="form-label">السقف المالي</label>
                    <input type="number" id="bank-ceiling" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                </div>
                <div class="form-group">
                    <label class="form-label">الرقم السري للبطاقة</label>
                    <input type="password" id="bank-pin" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                </div>
                <div class="flex gap-3 mt-4">
                    <button type="submit" class="btn-primary flex-1 text-white py-3 rounded-xl flex items-center justify-center gap-2">
                        <span id="bank-btn-text">حفظ</span>
                        <span id="bank-spinner" class="loading-spinner hidden"></span>
                    </button>
                    <button type="button" id="close-bank-modal" class="flex-1 bg-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-400 transition">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Debtor Modal -->
    <div id="debtor-modal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="glass-card p-6 responsive-modal">
            <h3 class="text-xl font-bold text-blue-900 mb-4 flex items-center">
                <i class="fas fa-user-plus ml-2"></i> <span id="debtor-modal-title">إضافة عميل مديون</span>
            </h3>
            <form id="debtor-form" class="space-y-4">
                <input type="hidden" id="debtor-edit-id" value="">
                <div class="form-group">
                    <label class="form-label">اسم العميل</label>
                    <input type="text" id="debtor-name" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                </div>
                <div class="form-group">
                    <label class="form-label">المبلغ المستحق</label>
                    <input type="number" id="debtor-amount" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                </div>
                <div class="form-group">
                    <label class="form-label">المنطقة</label>
                    <select id="debtor-region" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                        <option value="">اختر المنطقة</option>
                        <option value="khamis">خميس مشيط</option>
                        <option value="dharan">ظهران الجنوب</option>
                        <option value="other">باقي المناطق</option>
                    </select>
                </div>
                <div class="flex gap-3 mt-4">
                    <button type="submit" class="btn-primary flex-1 text-white py-3 rounded-xl flex items-center justify-center gap-2">
                        <span id="debtor-btn-text">حفظ</span>
                        <span id="debtor-spinner" class="loading-spinner hidden"></span>
                    </button>
                    <button type="button" id="close-debtor-modal" class="flex-1 bg-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-400 transition">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Failed Deposit Modal -->
    <div id="failed-modal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="glass-card p-6 responsive-modal">
            <h3 class="text-xl font-bold text-blue-900 mb-4 flex items-center">
                <i class="fas fa-times-circle ml-2"></i> إضافة عملية إيداع فاشلة
            </h3>
            <form id="failed-form" class="space-y-4">
                <!-- إضافة خانات التاريخ والوقت -->
                <div class="form-group">
                    <label class="form-label">التاريخ</label>
                    <input type="date" id="failed-date" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                </div>
                <div class="form-group">
                    <label class="form-label">الوقت</label>
                    <input type="time" id="failed-time" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                </div>
                <div class="form-group">
                    <label class="form-label">الحساب البنكي</label>
                    <select id="failed-bank-name" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                        <option value="">اختر الحساب</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">رقم الحساب</label>
                    <input type="text" id="failed-account-number" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                </div>
                <div class="form-group">
                    <label class="form-label">المبلغ</label>
                    <input type="number" id="failed-amount" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none" required>
                </div>
                <div class="form-group">
                    <label class="form-label">عنوان الفرع</label>
                    <input type="text" id="failed-branch-address" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                </div>
                <div class="form-group">
                    <label class="form-label">رقم الفرع</label>
                    <input type="text" id="failed-branch-number" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                </div>
                <div class="form-group">
                    <label class="form-label">رقم الجهاز</label>
                    <input type="text" id="failed-device-number" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                </div>
                <div class="form-group">
                    <label class="form-label">رقم البطاقة</label>
                    <input type="text" id="failed-card-number" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                </div>
                <div class="form-group">
                    <label class="form-label">اسم صاحب البطاقة</label>
                    <input type="text" id="failed-card-holder" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                </div>
                <div class="form-group">
                    <label class="form-label">رمز البطاقة</label>
                    <input type="text" id="failed-card-code" class="input-field w-full px-4 py-3 border-2 border-gray-200 focus:outline-none">
                </div>
                <div class="flex gap-3 mt-4">
                    <button type="submit" class="btn-primary flex-1 text-white py-3 rounded-xl flex items-center justify-center gap-2">
                        <span id="failed-btn-text">حفظ</span>
                        <span id="failed-spinner" class="loading-spinner hidden"></span>
                    </button>
                    <button type="button" id="close-failed-modal" class="flex-1 bg-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-400 transition">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="glass-card p-6 responsive-modal">
            <h3 class="text-xl font-bold text-blue-900 mb-4 flex items-center">
                <i class="fas fa-share-alt ml-2"></i> مشاركة التقرير
            </h3>
            <div class="share-template mb-4">
                <div id="share-content"></div>
            </div>
            <div class="flex gap-3">
                <button id="copy-share-btn" class="btn-primary flex-1 text-white py-3 rounded-xl flex items-center justify-center">
                    <i class="fas fa-copy ml-2"></i> نسخ
                </button>
                <button id="close-share-modal" class="flex-1 bg-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-400 transition">إغلاق</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDn7tMB8muUc05JSmVexfdWfBtzYZBiLPU",
            authDomain: "new-e586d.firebaseapp.com",
            projectId: "new-e586d",
            storageBucket: "new-e586d.firebasestorage.app",
            messagingSenderId: "987851655700",
            appId: "1:987851655700:web:76dd417b80421743ab7501",
            databaseURL: "https://new-e586d-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let allRecords = [];
        let currentAgent = '';
        let userType = '';
        const ADMIN_PASSWORD = 'mana1234';

        // دالة لتهيئة الفلاتر بتاريخ اليوم
        function initializeDateFilters() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const timeStr = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
            
            // تعيين جميع حقول الفلتر بتاريخ اليوم
            document.getElementById('data-entry-date').value = today;
            document.getElementById('daily-summary-date').value = today;
            document.getElementById('bank-accounts-date').value = today;
            document.getElementById('dashboard-date').value = today;
            document.getElementById('agents-date').value = today;
            document.getElementById('filter-date').value = today;
            
            // تعيين التاريخ والوقت في نموذج الإيداعات الفاشلة
            document.getElementById('failed-date').value = today;
            document.getElementById('failed-time').value = timeStr;
        }

        // الحصول على التاريخ المستهدف للإدخال
        function getTargetDate() {
            const dataEntryDate = document.getElementById('data-entry-date').value;
            return dataEntryDate || new Date().toISOString().split('T')[0];
        }

        // تهيئة السقوف عند بدء يوم جديد
        function initializeDailyCeilings() {
            const today = new Date().toISOString().split('T')[0];
            const lastInitialization = localStorage.getItem('lastInitializationDate');
            
            if (lastInitialization !== today) {
                // اليوم جديد، نقوم بحساب الرصيد النهائي لليوم السابق وتخزينه
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                // حساب الرصيد السابق لجميع المندوبين
                const agents = [...new Set(allRecords.map(r => r.agent_name))];
                
                agents.forEach(agent => {
                    if (agent && agent !== 'الإدارة') {
                        const yesterdayRecords = allRecords.filter(r => 
                            r.date === yesterdayStr && 
                            r.agent_name === agent &&
                            !r.is_bank_account && 
                            !r.is_debtor_customer && 
                            !r.is_failed_deposit
                        );
                        
                        const totals = calculateTotals(yesterdayRecords, agent, yesterdayStr);
                        const previousBalance = parseInt(localStorage.getItem(`previousBalance_${agent}_${yesterdayStr}`) || 0);
                        const finalBalance = previousBalance + totals.collections + totals.receipts - totals.deposits - totals.expenses - totals.deliveries - totals.failed;
                        
                        // تخزين الرصيد النهائي لليوم السابق كرصيد سابق لليوم الجديد
                        localStorage.setItem(`previousBalance_${agent}_${today}`, finalBalance);
                    }
                });
                
                localStorage.setItem('lastInitializationDate', today);
                showToast('تم تهيئة النظام ليوم جديد');
            }
        }

        // حساب رصيد الأمس للمندوب
        function calculatePreviousBalance(targetDate = null) {
            const date = targetDate || getTargetDate();
            const today = new Date(date);
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            // استخدام الرصيد المخزن مسبقاً لليوم السابق
            const previousBalance = parseInt(localStorage.getItem(`previousBalance_${currentAgent}_${date}`) || 0);
            
            document.getElementById('previous-balance').textContent = Math.round(previousBalance);
            
            return previousBalance;
        }

        // وظيفة التحقق من الوقت وبدء يوم جديد تلقائياً
        function checkForNewDay() {
            const now = new Date();
            const currentHour = now.getHours();
            
            // التحقق إذا كانت الساعة 1 صباحاً
            if (currentHour === 1) {
                const today = now.toISOString().split('T')[0];
                const lastInitialization = localStorage.getItem('lastInitializationDate');
                
                if (lastInitialization !== today) {
                    // بدء يوم جديد
                    initializeDailyCeilings();
                    initializeDateFilters();
                    updateUI();
                    showToast('تم بدء يوم جديد تلقائياً');
                }
            }
        }

        // تشغيل التحقق كل دقيقة
        setInterval(checkForNewDay, 60000);

        function updateDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('ar-EG', options);
        }
        updateDate();

        const recordsRef = ref(database, 'records');
        onValue(recordsRef, (snapshot) => {
            allRecords = [];
            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    allRecords.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
            }
            updateUI();
            initializeDailyCeilings();
        });

        // البحث في العملاء المديونين
        document.getElementById('debtor-search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('debtor-search-results');
            const debtors = allRecords.filter(r => r.is_debtor_customer);
            
            resultsContainer.innerHTML = '';
            
            if (searchTerm === '') {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const filteredDebtors = debtors.filter(d => 
                d.customer_name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredDebtors.length === 0) {
                resultsContainer.innerHTML = '<div class="option p-2 text-gray-500 text-center">لا توجد نتائج</div>';
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            filteredDebtors.forEach(debtor => {
                const div = document.createElement('div');
                div.className = 'option p-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100';
                div.textContent = `${debtor.customer_name} - المبلغ المستحق: ${Math.round(debtor.customer_debt)}`;
                div.addEventListener('click', () => {
                    selectDebtor(debtor);
                    resultsContainer.classList.add('hidden');
                    document.getElementById('debtor-search-input').value = debtor.customer_name;
                });
                resultsContainer.appendChild(div);
            });
            
            resultsContainer.classList.remove('hidden');
        });

        // إخفاء نتائج البحث عند النقر خارجها
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#debtor-select-div')) {
                document.getElementById('debtor-search-results').classList.add('hidden');
            }
        });

        // اختيار عميل من نتائج البحث
        function selectDebtor(debtor) {
            const customerName = document.getElementById('customer-name');
            const remainingDebtDiv = document.getElementById('remaining-debt-div');
            const remainingDebtAmount = document.getElementById('remaining-debt-amount');
            
            customerName.value = debtor.customer_name;
            customerName.disabled = true;
            remainingDebtDiv.classList.remove('hidden');
            remainingDebtAmount.textContent = Math.round(debtor.customer_debt);
            
            // تحديث القائمة المنسدلة
            document.getElementById('debtor-select').value = debtor.customer_name;
        }

        // استبعاد اسم العميل عند السحب من البطاقة
        document.getElementById('collection-type').addEventListener('change', (e) => {
            const bankCardDiv = document.getElementById('bank-card-select-div');
            const customerNameField = document.getElementById('customer-name-field');
            const debtorSelectDiv = document.getElementById('debtor-select-div');
            
            if (e.target.value === 'سحب من بطاقة') {
                bankCardDiv.classList.remove('hidden');
                customerNameField.classList.add('hidden');
                debtorSelectDiv.classList.add('hidden');
                document.getElementById('customer-name').required = false;
            } else {
                bankCardDiv.classList.add('hidden');
                customerNameField.classList.remove('hidden');
                debtorSelectDiv.classList.remove('hidden');
                document.getElementById('customer-name').required = true;
            }
            
            // حفظ آخر اختيار
            saveLastSelection('collection-type', e.target.value);
        });

        // أحداث تغيير نوع الاستلام
        document.getElementById('receipt-type').addEventListener('change', (e) => {
            const agentField = document.getElementById('receipt-agent-field');
            const companyField = document.getElementById('receipt-company-field');
            const submitBtn = document.querySelector('#receipt-form button[type="submit"]');
            
            if (e.target.value === 'مندوب') {
                agentField.classList.remove('hidden');
                companyField.classList.add('hidden');
                document.getElementById('receipt-agent-name').required = true;
                document.getElementById('receipt-company-name').required = false;
                submitBtn.querySelector('span').innerHTML = '<i class="fas fa-download ml-2"></i> استلام من مندوب';
            } else if (e.target.value === 'استلام نقدي لصالح شركة') {
                agentField.classList.add('hidden');
                companyField.classList.remove('hidden');
                document.getElementById('receipt-agent-name').required = false;
                document.getElementById('receipt-company-name').required = true;
                submitBtn.querySelector('span').innerHTML = '<i class="fas fa-download ml-2"></i> استلام نقدي';
            }
        });

        // أحداث تغيير نوع التسليم
        document.getElementById('delivery-type').addEventListener('change', (e) => {
            const submitBtn = document.querySelector('#delivery-form button[type="submit"]');
            
            if (e.target.value === 'مندوب') {
                submitBtn.querySelector('span').innerHTML = '<i class="fas fa-upload ml-2"></i> تسليم لمندوب';
            } else if (e.target.value === 'تسليم نقدي') {
                submitBtn.querySelector('span').innerHTML = '<i class="fas fa-upload ml-2"></i> تسليم نقدي';
            }
        });

        // تحميل آخر اختيار عند تحميل الصفحة
        function loadLastSelections() {
            const lastCollectionType = getLastSelection('collection-type');
            if (lastCollectionType) {
                document.getElementById('collection-type').value = lastCollectionType;
                // تشغيل الحدث لتحديث الواجهة
                document.getElementById('collection-type').dispatchEvent(new Event('change'));
            }
            
            const lastDepositBank = getLastSelection('deposit-bank');
            if (lastDepositBank) {
                document.getElementById('deposit-bank').value = lastDepositBank;
            }
            
            const lastFailedBank = getLastSelection('failed-bank-name');
            if (lastFailedBank) {
                document.getElementById('failed-bank-name').value = lastFailedBank;
            }
        }

        // تعبئة البيانات تلقائياً في نموذج الإيداعات الفاشلة
        document.getElementById('failed-bank-name').addEventListener('change', (e) => {
            const bankName = e.target.value;
            const bank = allRecords.find(r => r.is_bank_account && r.bank_account === bankName);
            
            if (bank) {
                document.getElementById('failed-account-number').value = bank.account_number || '';
                document.getElementById('failed-card-number').value = bank.card_number || '';
                document.getElementById('failed-card-holder').value = bank.card_holder || '';
            }
        });

        // إضافة شريط البحث في العملاء المديونين
        document.getElementById('debtor-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const activeRegion = document.querySelector('.region-tab.active').dataset.region;
            const regionId = activeRegion === 'all' ? 'debtors-list' : `debtors-list-${activeRegion}`;
            const list = document.getElementById(regionId);
            const debtors = allRecords.filter(r => r.is_debtor_customer);
            
            let filteredDebtors = debtors;
            if (activeRegion !== 'all') {
                filteredDebtors = debtors.filter(d => d.customer_region === activeRegion);
            }
            
            if (searchTerm) {
                filteredDebtors = filteredDebtors.filter(d => 
                    d.customer_name.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredDebtors.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500 py-12 text-lg">${searchTerm ? 'لا توجد نتائج للبحث' : 'لا توجد ديون مسجلة'}</p>`;
                return;
            }
            
            list.innerHTML = filteredDebtors.map(debtor => createDebtorCard(debtor, userType === 'agent')).join('');
        });

        document.getElementById('user-type').addEventListener('change', (e) => {
            const agentField = document.getElementById('agent-name-field');
            const agentInput = document.getElementById('agent-name-input');
            const adminPasswordField = document.getElementById('admin-password-field');
            const adminPasswordInput = document.getElementById('admin-password-input');
            
            if (e.target.value === 'agent') {
                agentField.classList.remove('hidden');
                agentInput.required = true;
                adminPasswordField.classList.add('hidden');
                adminPasswordInput.required = false;
            } else if (e.target.value === 'admin') {
                adminPasswordField.classList.remove('hidden');
                adminPasswordInput.required = true;
                agentField.classList.add('hidden');
                agentInput.required = false;
            } else {
                agentField.classList.add('hidden');
                agentInput.required = false;
                adminPasswordField.classList.add('hidden');
                adminPasswordInput.required = false;
            }
        });

        function checkSavedLogin() {
            const savedUserType = localStorage.getItem('userType');
            const savedAgent = localStorage.getItem('currentAgent');
            
            if (savedUserType && savedAgent) {
                userType = savedUserType;
                currentAgent = savedAgent;
                performLogin();
            }
        }
        
        function performLogin() {
            if (userType === 'agent') {
                document.getElementById('current-agent').textContent = `المندوب: ${currentAgent}`;
                
                const allTabs = document.querySelectorAll('.nav-tab');
                allTabs.forEach(tab => {
                    const tabName = tab.dataset.tab;
                    if (tabName === 'data-entry' || tabName === 'daily-summary' || tabName === 'bank-accounts' || tabName === 'debtor-customers' || tabName === 'failed-deposits') {
                        tab.classList.remove('hidden');
                    } else {
                        tab.classList.add('hidden');
                    }
                });
                
                document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
                document.querySelector('[data-tab="data-entry"]').classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                document.getElementById('data-entry-tab').classList.remove('hidden');
                
            } else if (userType === 'admin') {
                document.getElementById('current-agent').textContent = `المستخدم: الإدارة`;
                
                const allTabs = document.querySelectorAll('.nav-tab');
                allTabs.forEach(tab => {
                    const tabName = tab.dataset.tab;
                    if (tabName === 'bank-accounts' || tabName === 'debtor-customers' || tabName === 'failed-deposits' || tabName === 'all-operations' || tabName === 'dashboard' || tabName === 'agents') {
                        tab.classList.remove('hidden');
                    } else {
                        tab.classList.add('hidden');
                    }
                });
                
                document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
                document.querySelector('[data-tab="all-operations"]').classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                document.getElementById('all-operations-tab').classList.remove('hidden');
            }
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            
            const adminButtons = document.querySelectorAll('.admin-only');
            adminButtons.forEach(btn => {
                if (userType === 'admin') {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });
            
            // تهيئة الفلاتر بتاريخ اليوم
            initializeDateFilters();
            
            updateUI();
            loadLastSelections();
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            userType = document.getElementById('user-type').value;
            
            if (userType === 'agent') {
                currentAgent = document.getElementById('agent-name-input').value.trim();
                if (!currentAgent) {
                    showToast('يرجى إدخال اسم المندوب', 'error');
                    return;
                }
                
                localStorage.setItem('userType', userType);
                localStorage.setItem('currentAgent', currentAgent);
                performLogin();
                
            } else if (userType === 'admin') {
                const password = document.getElementById('admin-password-input').value;
                if (password !== ADMIN_PASSWORD) {
                    showToast('كلمة المرور غير صحيحة', 'error');
                    return;
                }
                
                currentAgent = 'الإدارة';
                localStorage.setItem('userType', userType);
                localStorage.setItem('currentAgent', currentAgent);
                performLogin();
            }
        });
        
        checkSavedLogin();
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('userType');
            localStorage.removeItem('currentAgent');
            location.reload();
        });

        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                const tabId = btn.dataset.tab + '-tab';
                document.getElementById(tabId).classList.remove('hidden');
                
                updateUI();
            });
        });

        // إضافة أحداث لتبويبات المناطق
        document.querySelectorAll('.region-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.region-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.querySelectorAll('.region-section').forEach(s => s.classList.remove('active'));
                const regionId = 'debtors-' + tab.dataset.region;
                document.getElementById(regionId).classList.add('active');
                
                // إعادة تطبيق البحث عند تغيير المنطقة
                document.getElementById('debtor-search').dispatchEvent(new Event('input'));
            });
        });

        // إضافة أحداث للفلاتر الجديدة
        document.getElementById('apply-data-entry-filter').addEventListener('click', updateUI);
        document.getElementById('apply-daily-filter').addEventListener('click', updateDailySummary);
        document.getElementById('apply-bank-filter').addEventListener('click', updateBankAccountsList);
        document.getElementById('apply-dashboard-filter').addEventListener('click', updateDashboard);
        document.getElementById('apply-agents-filter').addEventListener('click', updateAgentsList);
        document.getElementById('apply-all-operations-filter').addEventListener('click', updateAllOperations);

        // زر بدء يوم جديد
        document.getElementById('reset-day-btn').addEventListener('click', () => {
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed bottom-20 right-4 glass-card p-4 z-50 shadow-2xl max-w-xs';
            confirmDiv.innerHTML = `
                <p class="font-bold mb-3 text-blue-900">هل تريد بدء يوم جديد؟ سيتم حساب الرصيد النهائي لليوم الحالي وتخزينه كرصيد سابق لليوم الجديد.</p>
                <div class="flex gap-2">
                    <button id="confirm-reset" class="btn-primary text-white px-4 py-2 rounded-xl text-sm font-bold flex-1">نعم، ابدأ</button>
                    <button id="cancel-reset" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-xl text-sm font-bold flex-1 hover:bg-gray-400 transition">إلغاء</button>
                </div>
            `;
            document.body.appendChild(confirmDiv);
            
            document.getElementById('confirm-reset').addEventListener('click', () => {
                // حساب الرصيد النهائي لليوم الحالي وتخزينه
                const today = new Date().toISOString().split('T')[0];
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                const agents = [...new Set(allRecords.map(r => r.agent_name))];
                
                agents.forEach(agent => {
                    if (agent && agent !== 'الإدارة') {
                        const todayRecords = allRecords.filter(r => 
                            r.date === today && 
                            r.agent_name === agent &&
                            !r.is_bank_account && 
                            !r.is_debtor_customer && 
                            !r.is_failed_deposit
                        );
                        
                        const totals = calculateTotals(todayRecords, agent, today);
                        const previousBalance = parseInt(localStorage.getItem(`previousBalance_${agent}_${today}`) || 0);
                        const finalBalance = previousBalance + totals.collections + totals.receipts - totals.deposits - totals.expenses - totals.deliveries - totals.failed;
                        
                        // تخزين الرصيد النهائي لليوم الحالي كرصيد سابق لليوم الجديد
                        localStorage.setItem(`previousBalance_${agent}_${tomorrowStr}`, finalBalance);
                    }
                });
                
                // إعادة تعيين تاريخ التهيئة الأخير
                localStorage.setItem('lastInitializationDate', tomorrowStr);
                
                // إعادة تعيين الفلاتر
                initializeDateFilters();
                
                showToast('تم بدء يوم جديد بنجاح');
                confirmDiv.remove();
                updateUI();
            });
            
            document.getElementById('cancel-reset').addEventListener('click', () => {
                confirmDiv.remove();
            });
        });

        // حفظ آخر اختيار
        function saveLastSelection(fieldId, value) {
            localStorage.setItem(fieldId, value);
        }

        // استرجاع آخر اختيار
        function getLastSelection(fieldId) {
            return localStorage.getItem(fieldId);
        }

        // دالة لتعديل السجلات
        function enableEditOperation(record) {
            if (record.type === 'collection') {
                document.getElementById('collection-edit-id').value = record.id;
                document.getElementById('collection-type').value = record.collection_type;
                document.getElementById('collection-type').dispatchEvent(new Event('change'));
                
                if (record.collection_type === 'سحب من بطاقة') {
                    document.getElementById('collection-bank-card').value = record.bank_account || '';
                } else {
                    document.getElementById('customer-name').value = record.customer_name || '';
                }
                
                document.getElementById('collection-amount').value = record.amount;
                document.getElementById('collection-btn-text').innerHTML = '<i class="fas fa-edit ml-2"></i> تعديل التحصيل';
                document.getElementById('collection-cancel-edit').classList.remove('hidden');
                
                // التمرير للنموذج
                document.querySelector('[data-tab="data-entry"]').click();
            } else if (record.type === 'deposit') {
                document.getElementById('deposit-edit-id').value = record.id;
                document.getElementById('deposit-bank').value = record.bank_account || '';
                document.getElementById('deposit-amount').value = record.amount;
                document.getElementById('deposit-btn-text').innerHTML = '<i class="fas fa-edit ml-2"></i> تعديل الإيداع';
                document.getElementById('deposit-cancel-edit').classList.remove('hidden');
                
                document.querySelector('[data-tab="data-entry"]').click();
            } else if (record.type === 'expense') {
                document.getElementById('expense-edit-id').value = record.id;
                document.getElementById('expense-type').value = record.expense_type || '';
                document.getElementById('expense-amount').value = record.amount;
                document.getElementById('expense-details').value = record.expense_details || '';
                document.getElementById('expense-btn-text').innerHTML = '<i class="fas fa-edit ml-2"></i> تعديل المصروف';
                document.getElementById('expense-cancel-edit').classList.remove('hidden');
                
                document.querySelector('[data-tab="data-entry"]').click();
            } else if (record.type === 'receipt') {
                document.getElementById('receipt-edit-id').value = record.id;
                document.getElementById('receipt-type').value = record.receipt_type || '';
                document.getElementById('receipt-type').dispatchEvent(new Event('change'));
                
                if (record.receipt_type === 'مندوب') {
                    document.getElementById('receipt-agent-name').value = record.received_from || '';
                } else if (record.receipt_type === 'استلام نقدي لصالح شركة') {
                    document.getElementById('receipt-company-name').value = record.received_from || '';
                }
                
                document.getElementById('receipt-amount').value = record.amount;
                document.getElementById('receipt-btn-text').innerHTML = '<i class="fas fa-edit ml-2"></i> تعديل الاستلام';
                document.getElementById('receipt-cancel-edit').classList.remove('hidden');
                
                document.querySelector('[data-tab="data-entry"]').click();
            } else if (record.type === 'delivery') {
                document.getElementById('delivery-edit-id').value = record.id;
                document.getElementById('delivery-type').value = record.delivery_type || '';
                document.getElementById('delivery-recipient').value = record.delivered_to || '';
                document.getElementById('delivery-amount').value = record.amount;
                document.getElementById('delivery-btn-text').innerHTML = '<i class="fas fa-edit ml-2"></i> تعديل التسليم';
                document.getElementById('delivery-cancel-edit').classList.remove('hidden');
                
                document.querySelector('[data-tab="data-entry"]').click();
            }
        }

        // إلغاء التعديل
        document.getElementById('collection-cancel-edit').addEventListener('click', () => {
            document.getElementById('collection-edit-id').value = '';
            document.getElementById('collection-btn-text').innerHTML = '<i class="fas fa-plus-circle ml-2"></i> إضافة تحصيل';
            document.getElementById('collection-cancel-edit').classList.add('hidden');
            document.getElementById('collection-form').reset();
            document.getElementById('customer-name').disabled = false;
            document.getElementById('remaining-debt-div').classList.add('hidden');
        });

        document.getElementById('deposit-cancel-edit').addEventListener('click', () => {
            document.getElementById('deposit-edit-id').value = '';
            document.getElementById('deposit-btn-text').innerHTML = '<i class="fas fa-plus-circle ml-2"></i> إضافة إيداع';
            document.getElementById('deposit-cancel-edit').classList.add('hidden');
            document.getElementById('deposit-form').reset();
        });

        document.getElementById('expense-cancel-edit').addEventListener('click', () => {
            document.getElementById('expense-edit-id').value = '';
            document.getElementById('expense-btn-text').innerHTML = '<i class="fas fa-plus-circle ml-2"></i> إضافة مصروف';
            document.getElementById('expense-cancel-edit').classList.add('hidden');
            document.getElementById('expense-form').reset();
        });

        document.getElementById('receipt-cancel-edit').addEventListener('click', () => {
            document.getElementById('receipt-edit-id').value = '';
            document.getElementById('receipt-btn-text').innerHTML = '<i class="fas fa-download ml-2"></i> استلام نقدي';
            document.getElementById('receipt-cancel-edit').classList.add('hidden');
            document.getElementById('receipt-form').reset();
        });

        document.getElementById('delivery-cancel-edit').addEventListener('click', () => {
            document.getElementById('delivery-edit-id').value = '';
            document.getElementById('delivery-btn-text').innerHTML = '<i class="fas fa-upload ml-2"></i> تسليم نقدي';
            document.getElementById('delivery-cancel-edit').classList.add('hidden');
            document.getElementById('delivery-form').reset();
        });

        async function submitOperation(btn, spinner, record, successMsg, shareGenerator, isEdit = false, editId = null) {
            btn.textContent = isEdit ? 'جاري التعديل...' : 'جاري الإضافة...';
            spinner.classList.remove('hidden');

            try {
                if (isEdit && editId) {
                    // تحديث السجل الموجود
                    const recordRef = ref(database, 'records/' + editId);
                    await update(recordRef, record);
                    showToast(successMsg.replace('إضافة', 'تعديل'));
                } else {
                    // إضافة سجل جديد
                    const newRecordRef = push(recordsRef);
                    await set(newRecordRef, record);
                    showToast(successMsg);
                    if (shareGenerator) {
                        showShareModal(shareGenerator(record));
                    }
                }
                return true;
            } catch (error) {
                showToast((isEdit ? 'فشل في تعديل العملية: ' : 'فشل في إضافة العملية: ') + error.message, 'error');
                return false;
            } finally {
                btn.textContent = btn.dataset.originalText;
                spinner.classList.add('hidden');
            }
        }

        document.getElementById('collection-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('collection-btn-text');
            const spinner = document.getElementById('collection-spinner');
            btn.dataset.originalText = btn.textContent;

            const now = new Date();
            const targetDate = getTargetDate();
            const collectionType = document.getElementById('collection-type').value;
            const record = {
                type: 'collection',
                agent_name: currentAgent,
                collection_type: collectionType,
                customer_name: collectionType === 'سحب من بطاقة' ? '' : document.getElementById('customer-name').value,
                amount: Math.round(parseFloat(document.getElementById('collection-amount').value)),
                date: targetDate,
                time: now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes(),
                is_bank_account: false,
                is_debtor_customer: false,
                is_failed_deposit: false
            };

            if (collectionType === 'سحب من بطاقة') {
                record.bank_account = document.getElementById('collection-bank-card').value;
            }

            const editId = document.getElementById('collection-edit-id').value;
            const isEdit = !!editId;

            // إذا كان العميل من العملاء المديونين، نقوم بتحديث المبلغ المتبقي
            const debtorSelect = document.getElementById('debtor-select');
            if (debtorSelect.value && collectionType === 'نقدي') {
                const debtor = allRecords.find(d => 
                    d.is_debtor_customer && 
                    d.customer_name === debtorSelect.value
                );
                
                if (debtor) {
                    const remainingDebt = debtor.customer_debt - record.amount;
                    
                    // تحديث سجل العميل المديون
                    if (remainingDebt > 0) {
                        const debtorRef = ref(database, 'records/' + debtor.id);
                        await update(debtorRef, {
                            ...debtor,
                            customer_debt: remainingDebt
                        });
                        showToast(`تم تحديث المبلغ المتبقي للعميل: ${Math.round(remainingDebt)}`);
                    } else {
                        // إذا تم سداد الدين بالكامل، يمكن حذف العميل من قائمة المديونين
                        const debtorRef = ref(database, 'records/' + debtor.id);
                        await remove(debtorRef);
                        showToast('تم سداد الدين بالكامل وتم إزالة العميل من قائمة المديونين');
                    }
                }
            }

            const success = await submitOperation(btn, spinner, record, 'تم إضافة التحصيل بنجاح ✅', 
                (r) => {
                    if (r.collection_type === 'سحب من بطاقة') {
                        const totalActivity = getTotalBankActivity(r.bank_account, targetDate);
                        return generateWithdrawalShare(r, totalActivity);
                    }
                    
                    // إضافة المبلغ المتبقي في التقرير المشارك إذا كان العميل مديوناً
                    let shareText = generateOperationShare(r, '💰 عملية تحصيل جديدة');
                    if (debtorSelect.value && collectionType === 'نقدي') {
                        const debtor = allRecords.find(d => 
                            d.is_debtor_customer && 
                            d.customer_name === debtorSelect.value
                        );
                        if (debtor) {
                            const remainingDebt = debtor.customer_debt - record.amount;
                            if (remainingDebt > 0) {
                                shareText += `\n\n💳 المبلغ المتبقي على العميل: ${Math.round(remainingDebt)}`;
                            } else {
                                shareText += `\n\n✅ تم سداد الدين بالكامل`;
                            }
                        }
                    }
                    return shareText;
                },
                isEdit,
                editId
            );
            
            if (success) {
                e.target.reset();
                document.getElementById('bank-card-select-div').classList.add('hidden');
                document.getElementById('customer-name-field').classList.remove('hidden');
                document.getElementById('customer-name').required = true;
                document.getElementById('customer-name').disabled = false;
                document.getElementById('remaining-debt-div').classList.add('hidden');
                
                // إعادة تعيين وضع التعديل
                if (isEdit) {
                    document.getElementById('collection-edit-id').value = '';
                    document.getElementById('collection-btn-text').innerHTML = '<i class="fas fa-plus-circle ml-2"></i> إضافة تحصيل';
                    document.getElementById('collection-cancel-edit').classList.add('hidden');
                }
            }
        });

        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('deposit-btn-text');
            const spinner = document.getElementById('deposit-spinner');
            btn.dataset.originalText = btn.textContent;

            const now = new Date();
            const targetDate = getTargetDate();
            const bankAccount = document.getElementById('deposit-bank').value;
            const amount = Math.round(parseFloat(document.getElementById('deposit-amount').value));
            
            // حفظ آخر اختيار
            saveLastSelection('deposit-bank', bankAccount);
            
            const record = {
                type: 'deposit',
                agent_name: currentAgent,
                bank_account: bankAccount,
                amount: amount,
                date: targetDate,
                time: now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes(),
                is_bank_account: false,
                is_debtor_customer: false,
                is_failed_deposit: false
            };

            const editId = document.getElementById('deposit-edit-id').value;
            const isEdit = !!editId;

            const success = await submitOperation(btn, spinner, record, 'تم إضافة الإيداع بنجاح ✅',
                (r) => {
                    const bank = allRecords.find(b => b.is_bank_account && b.bank_account === bankAccount);
                    if (bank) {
                        const totalDeposits = getTotalDepositsForBank(bankAccount, targetDate);
                        const remaining = bank.financial_ceiling - totalDeposits;
                        return generateDepositShare(r, remaining);
                    }
                    return generateOperationShare(r, '🏦 إيداع بنكي جديد');
                },
                isEdit,
                editId
            );
            
            if (success) {
                e.target.reset();
                
                // إعادة تعيين وضع التعديل
                if (isEdit) {
                    document.getElementById('deposit-edit-id').value = '';
                    document.getElementById('deposit-btn-text').innerHTML = '<i class="fas fa-plus-circle ml-2"></i> إضافة إيداع';
                    document.getElementById('deposit-cancel-edit').classList.add('hidden');
                }
            }
        });

        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('expense-btn-text');
            const spinner = document.getElementById('expense-spinner');
            btn.dataset.originalText = btn.textContent;

            const now = new Date();
            const targetDate = getTargetDate();
            const record = {
                type: 'expense',
                agent_name: currentAgent,
                expense_type: document.getElementById('expense-type').value,
                expense_details: document.getElementById('expense-details').value,
                amount: Math.round(parseFloat(document.getElementById('expense-amount').value)),
                date: targetDate,
                time: now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes(),
                is_bank_account: false,
                is_debtor_customer: false,
                is_failed_deposit: false
            };

            const editId = document.getElementById('expense-edit-id').value;
            const isEdit = !!editId;

            const success = await submitOperation(btn, spinner, record, 'تم إضافة المصروف بنجاح ✅',
                (r) => generateOperationShare(r, '💸 مصروف جديد'),
                isEdit,
                editId
            );
            
            if (success) {
                e.target.reset();
                
                // إعادة تعيين وضع التعديل
                if (isEdit) {
                    document.getElementById('expense-edit-id').value = '';
                    document.getElementById('expense-btn-text').innerHTML = '<i class="fas fa-plus-circle ml-2"></i> إضافة مصروف';
                    document.getElementById('expense-cancel-edit').classList.add('hidden');
                }
            }
        });

        // نموذج الاستلام
        document.getElementById('receipt-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('receipt-btn-text');
            const spinner = document.getElementById('receipt-spinner');
            btn.dataset.originalText = btn.textContent;

            const now = new Date();
            const targetDate = getTargetDate();
            const receiptType = document.getElementById('receipt-type').value;
            
            let receivedFrom = '';
            if (receiptType === 'مندوب') {
                receivedFrom = document.getElementById('receipt-agent-name').value;
            } else if (receiptType === 'استلام نقدي لصالح شركة') {
                receivedFrom = document.getElementById('receipt-company-name').value;
            }
            
            const record = {
                type: 'receipt',
                agent_name: currentAgent,
                receipt_type: receiptType,
                received_from: receivedFrom,
                amount: Math.round(parseFloat(document.getElementById('receipt-amount').value)),
                date: targetDate,
                time: now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes(),
                is_bank_account: false,
                is_debtor_customer: false,
                is_failed_deposit: false
            };

            const editId = document.getElementById('receipt-edit-id').value;
            const isEdit = !!editId;

            const success = await submitOperation(btn, spinner, record, 'تم إضافة الاستلام بنجاح ✅',
                (r) => generateReceiptShare(r),
                isEdit,
                editId
            );
            
            if (success) {
                e.target.reset();
                
                if (isEdit) {
                    document.getElementById('receipt-edit-id').value = '';
                    document.getElementById('receipt-btn-text').innerHTML = '<i class="fas fa-download ml-2"></i> استلام نقدي';
                    document.getElementById('receipt-cancel-edit').classList.remove('hidden');
                }
            }
        });

        // نموذج التسليم
        document.getElementById('delivery-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('delivery-btn-text');
            const spinner = document.getElementById('delivery-spinner');
            btn.dataset.originalText = btn.textContent;

            const now = new Date();
            const targetDate = getTargetDate();
            const deliveryType = document.getElementById('delivery-type').value;
            const recipient = document.getElementById('delivery-recipient').value;
            
            const record = {
                type: 'delivery',
                agent_name: currentAgent,
                delivery_type: deliveryType,
                delivered_to: recipient,
                amount: Math.round(parseFloat(document.getElementById('delivery-amount').value)),
                date: targetDate,
                time: now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes(),
                is_bank_account: false,
                is_debtor_customer: false,
                is_failed_deposit: false
            };

            const editId = document.getElementById('delivery-edit-id').value;
            const isEdit = !!editId;

            const success = await submitOperation(btn, spinner, record, 'تم إضافة التسليم بنجاح ✅',
                (r) => generateDeliveryShare(r),
                isEdit,
                editId
            );
            
            if (success) {
                e.target.reset();
                
                if (isEdit) {
                    document.getElementById('delivery-edit-id').value = '';
                    document.getElementById('delivery-btn-text').innerHTML = '<i class="fas fa-upload ml-2"></i> تسليم نقدي';
                    document.getElementById('delivery-cancel-edit').classList.remove('hidden');
                }
            }
        });

        document.getElementById('add-bank-btn').addEventListener('click', () => {
            document.getElementById('bank-modal').classList.remove('hidden');
            document.getElementById('bank-modal-title').textContent = 'إضافة حساب بنكي';
            document.getElementById('bank-btn-text').textContent = 'حفظ';
        });

        document.getElementById('close-bank-modal').addEventListener('click', () => {
            document.getElementById('bank-modal').classList.add('hidden');
            document.getElementById('bank-form').reset();
            document.getElementById('bank-edit-id').value = '';
        });

        document.getElementById('bank-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('bank-btn-text');
            const spinner = document.getElementById('bank-spinner');
            btn.textContent = 'جاري الحفظ...';
            spinner.classList.remove('hidden');

            const now = new Date();
            const targetDate = getTargetDate();
            const record = {
                type: 'bank_account',
                agent_name: currentAgent,
                bank_account: document.getElementById('bank-name').value,
                account_number: document.getElementById('bank-account-number').value,
                card_number: document.getElementById('bank-card-number').value,
                card_holder: document.getElementById('bank-card-holder').value,
                financial_ceiling: Math.round(parseFloat(document.getElementById('bank-ceiling').value)),
                card_pin: document.getElementById('bank-pin').value,
                date: targetDate,
                time: now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes(),
                is_bank_account: true,
                is_debtor_customer: false,
                is_failed_deposit: false
            };

            const editId = document.getElementById('bank-edit-id').value;
            const isEdit = !!editId;

            try {
                if (isEdit) {
                    // تحديث الحساب البنكي الموجود
                    const recordRef = ref(database, 'records/' + editId);
                    await update(recordRef, record);
                    showToast('تم تعديل الحساب البنكي بنجاح ✅');
                } else {
                    // إضافة حساب بنكي جديد
                    const newRecordRef = push(recordsRef);
                    await set(newRecordRef, record);
                    showToast('تم إضافة الحساب البنكي بنجاح ✅');
                }
                
                document.getElementById('bank-modal').classList.add('hidden');
                e.target.reset();
                document.getElementById('bank-edit-id').value = '';
            } catch (error) {
                showToast((isEdit ? 'فشل في تعديل الحساب البنكي: ' : 'فشل في إضافة الحساب البنكي: ') + error.message, 'error');
            }
            
            btn.textContent = 'حفظ';
            spinner.classList.add('hidden');
        });

        // دالة لتعديل الحسابات البنكية
        function enableEditBankAccount(bank) {
            document.getElementById('bank-edit-id').value = bank.id;
            document.getElementById('bank-name').value = bank.bank_account || '';
            document.getElementById('bank-account-number').value = bank.account_number || '';
            document.getElementById('bank-card-number').value = bank.card_number || '';
            document.getElementById('bank-card-holder').value = bank.card_holder || '';
            document.getElementById('bank-ceiling').value = bank.financial_ceiling || '';
            document.getElementById('bank-pin').value = bank.card_pin || '';
            
            document.getElementById('bank-modal-title').textContent = 'تعديل حساب بنكي';
            document.getElementById('bank-btn-text').textContent = 'تحديث';
            document.getElementById('bank-modal').classList.remove('hidden');
        }

        document.getElementById('add-debtor-btn').addEventListener('click', () => {
            document.getElementById('debtor-modal').classList.remove('hidden');
            document.getElementById('debtor-modal-title').textContent = 'إضافة عميل مديون';
            document.getElementById('debtor-btn-text').textContent = 'حفظ';
            document.getElementById('debtor-edit-id').value = '';
        });

        document.getElementById('close-debtor-modal').addEventListener('click', () => {
            document.getElementById('debtor-modal').classList.add('hidden');
            document.getElementById('debtor-form').reset();
            document.getElementById('debtor-edit-id').value = '';
        });

        document.getElementById('debtor-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('debtor-btn-text');
            const spinner = document.getElementById('debtor-spinner');
            btn.textContent = 'جاري الحفظ...';
            spinner.classList.remove('hidden');

            const now = new Date();
            const targetDate = getTargetDate();
            const record = {
                type: 'debtor',
                agent_name: currentAgent,
                customer_name: document.getElementById('debtor-name').value,
                customer_debt: Math.round(parseFloat(document.getElementById('debtor-amount').value)),
                customer_region: document.getElementById('debtor-region').value,
                date: targetDate,
                time: now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes(),
                is_bank_account: false,
                is_debtor_customer: true,
                is_failed_deposit: false
            };

            const editId = document.getElementById('debtor-edit-id').value;
            const isEdit = !!editId;

            try {
                if (isEdit) {
                    // تحديث العميل المديون الموجود
                    const recordRef = ref(database, 'records/' + editId);
                    await update(recordRef, record);
                    showToast('تم تعديل العميل المديون بنجاح ✅');
                } else {
                    // إضافة عميل مديون جديد
                    const newRecordRef = push(recordsRef);
                    await set(newRecordRef, record);
                    showToast('تم إضافة العميل المديون بنجاح ✅');
                }
                
                document.getElementById('debtor-modal').classList.add('hidden');
                e.target.reset();
                document.getElementById('debtor-edit-id').value = '';
            } catch (error) {
                showToast((isEdit ? 'فشل في تعديل العميل المديون: ' : 'فشل في إضافة العميل المديون: ') + error.message, 'error');
            }
            
            btn.textContent = 'حفظ';
            spinner.classList.add('hidden');
        });

        // دالة لتعديل العميل المديون
        function enableEditDebtor(debtor) {
            document.getElementById('debtor-edit-id').value = debtor.id;
            document.getElementById('debtor-name').value = debtor.customer_name || '';
            document.getElementById('debtor-amount').value = debtor.customer_debt || '';
            document.getElementById('debtor-region').value = debtor.customer_region || '';
            
            document.getElementById('debtor-modal-title').textContent = 'تعديل عميل مديون';
            document.getElementById('debtor-btn-text').textContent = 'تحديث';
            document.getElementById('debtor-modal').classList.remove('hidden');
        }

        document.getElementById('add-failed-btn').addEventListener('click', () => {
            document.getElementById('failed-modal').classList.remove('hidden');
        });

        document.getElementById('close-failed-modal').addEventListener('click', () => {
            document.getElementById('failed-modal').classList.add('hidden');
            document.getElementById('failed-form').reset();
        });

        document.getElementById('failed-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('failed-btn-text');
            const spinner = document.getElementById('failed-spinner');
            btn.textContent = 'جاري الحفظ...';
            spinner.classList.remove('hidden');

            const targetDate = document.getElementById('failed-date').value;
            const targetTime = document.getElementById('failed-time').value;
            const bankAccount = document.getElementById('failed-bank-name').value;
            
            // حفظ آخر اختيار
            saveLastSelection('failed-bank-name', bankAccount);
            
            const record = {
                type: 'failed_deposit',
                agent_name: currentAgent,
                bank_account: bankAccount,
                account_number: document.getElementById('failed-account-number').value,
                amount: Math.round(parseFloat(document.getElementById('failed-amount').value)),
                branch_address: document.getElementById('failed-branch-address').value,
                branch_number: document.getElementById('failed-branch-number').value,
                device_number: document.getElementById('failed-device-number').value,
                card_number: document.getElementById('failed-card-number').value,
                card_holder: document.getElementById('failed-card-holder').value,
                card_code: document.getElementById('failed-card-code').value,
                date: targetDate,
                time: targetTime,
                is_bank_account: false,
                is_debtor_customer: false,
                is_failed_deposit: true
            };

            try {
                const newRecordRef = push(recordsRef);
                await set(newRecordRef, record);
                
                document.getElementById('failed-modal').classList.add('hidden');
                e.target.reset();
                showToast('تم إضافة العملية الفاشلة بنجاح ✅');
            } catch (error) {
                showToast('فشل في إضافة العملية الفاشلة: ' + error.message, 'error');
            }
            
            btn.textContent = 'حفظ';
            spinner.classList.add('hidden');
        });

        document.getElementById('close-share-modal').addEventListener('click', () => {
            document.getElementById('share-modal').classList.add('hidden');
        });

        document.getElementById('copy-share-btn').addEventListener('click', () => {
            const text = document.getElementById('share-content').innerText;
            navigator.clipboard.writeText(text).then(() => {
                showToast('تم نسخ التقرير ✅');
            }).catch(err => {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('تم نسخ التقرير ✅');
            });
        });

        document.getElementById('share-summary-btn').addEventListener('click', () => {
            const shareText = generateSummaryReport();
            showShareModal(shareText);
        });

        document.getElementById('share-detailed-btn').addEventListener('click', () => {
            const shareText = generateDetailedReport();
            showShareModal(shareText);
        });

        // Filter operations
        document.getElementById('filter-agent').addEventListener('change', updateAllOperations);
        document.getElementById('filter-type').addEventListener('change', updateAllOperations);
        document.getElementById('filter-date').addEventListener('change', updateAllOperations);

        function showShareModal(htmlContent) {
            document.getElementById('share-content').innerHTML = htmlContent;
            document.getElementById('share-modal').classList.remove('hidden');
        }

        function getTodayRecords() {
            const today = new Date().toISOString().split('T')[0];
            return allRecords.filter(r => r.date === today && !r.is_bank_account && !r.is_debtor_customer && !r.is_failed_deposit);
        }

        function getTodayAgentRecords() {
            return getTodayRecords().filter(r => r.agent_name === currentAgent);
        }

        function getRecordsByDate(date) {
            return allRecords.filter(r => r.date === date && !r.is_bank_account && !r.is_debtor_customer && !r.is_failed_deposit);
        }

        function getAgentRecordsByDate(date) {
            return getRecordsByDate(date).filter(r => r.agent_name === currentAgent);
        }

        function calculateTotals(records, agent = null, date = null) {
            let collections = 0, deposits = 0, expenses = 0, receipts = 0, deliveries = 0, failed = 0;
            
            records.forEach(r => {
                if (r.type === 'collection') collections += r.amount || 0;
                else if (r.type === 'deposit') deposits += r.amount || 0;
                else if (r.type === 'expense') expenses += r.amount || 0;
                else if (r.type === 'receipt') receipts += r.amount || 0;
                else if (r.type === 'delivery') deliveries += r.amount || 0;
            });
            
            // حساب الإيداعات الفاشلة
            const targetDate = date || getTargetDate();
            const targetAgent = agent || currentAgent;
            const failedDeposits = allRecords.filter(r => 
                r.is_failed_deposit && 
                r.date === targetDate && 
                r.agent_name === targetAgent
            );
            
            failed = failedDeposits.reduce((sum, r) => sum + (r.amount || 0), 0);
            
            return { collections, deposits, expenses, receipts, deliveries, failed };
        }

        function getTotalDepositsForBank(bankAccount, date = null) {
            const targetDate = date || getTargetDate();
            return allRecords
                .filter(r => r.type === 'deposit' && r.bank_account === bankAccount && r.date === targetDate)
                .reduce((sum, r) => sum + (r.amount || 0), 0);
        }

        function getTotalWithdrawalsForBank(bankAccount, date = null) {
            const targetDate = date || getTargetDate();
            return allRecords
                .filter(r => r.type === 'collection' && r.collection_type === 'سحب من بطاقة' && r.bank_account === bankAccount && r.date === targetDate)
                .reduce((sum, r) => sum + (r.amount || 0), 0);
        }
        
        function getTotalBankActivity(bankAccount, date = null) {
            const targetDate = date || getTargetDate();
            const deposits = getTotalDepositsForBank(bankAccount, targetDate);
            const withdrawals = getTotalWithdrawalsForBank(bankAccount, targetDate);
            return deposits + withdrawals;
        }
        
        function formatTime(timeStr) {
            const parts = timeStr.split(':');
            return `${parts[0]}:${parts[1]}`;
        }
        
        function formatDateForShare(dateStr, timeStr) {
            const date = new Date(dateStr + 'T' + timeStr);
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            const hours = date.getHours();
            const minutes = date.getMinutes();
            return `${day}/${month}/${year} - ${hours}:${minutes.toString().padStart(2, '0')}`;
        }

        function updateUI() {
            updateBankAccountsDropdown();
            updateBankCardsDropdown();
            updateDebtorSelect();
            updateDailySummary();
            updateBankAccountsList();
            updateDebtorsList();
            updateFailedDepositsList();
            updateAllOperations();
            updateDashboard();
            updateAgentsList();
            updateFilterAgents();
        }

        function updateBankAccountsDropdown() {
            const depositSelect = document.getElementById('deposit-bank');
            const failedSelect = document.getElementById('failed-bank-name');
            const banks = allRecords.filter(r => r.is_bank_account);
            
            depositSelect.innerHTML = '<option value="">اختر الحساب</option>';
            failedSelect.innerHTML = '<option value="">اختر الحساب</option>';
            
            banks.forEach(bank => {
                const option1 = document.createElement('option');
                option1.value = bank.bank_account;
                option1.textContent = bank.bank_account;
                depositSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = bank.bank_account;
                option2.textContent = bank.bank_account;
                failedSelect.appendChild(option2);
            });
        }

        function updateBankCardsDropdown() {
            const select = document.getElementById('collection-bank-card');
            const banks = allRecords.filter(r => r.is_bank_account);
            
            select.innerHTML = '<option value="">اختر البطاقة</option>';
            banks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank.bank_account;
                option.textContent = bank.bank_account;
                select.appendChild(option);
            });
        }

        function updateDebtorSelect() {
            const debtorSelect = document.getElementById('debtor-select');
            const debtors = allRecords.filter(r => r.is_debtor_customer);
            
            debtorSelect.innerHTML = '<option value="">اختر العميل</option>';
            debtors.forEach(debtor => {
                const option = document.createElement('option');
                option.value = debtor.customer_name;
                option.textContent = `${debtor.customer_name} - ${Math.round(debtor.customer_debt)}`;
                option.dataset.debt = debtor.customer_debt;
                debtorSelect.appendChild(option);
            });
        }

        function updateFilterAgents() {
            const select = document.getElementById('filter-agent');
            const agents = [...new Set(allRecords
                .filter(r => !r.is_bank_account && !r.is_debtor_customer && !r.is_failed_deposit)
                .map(r => r.agent_name))];
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">الكل</option>';
            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent;
                option.textContent = agent;
                select.appendChild(option);
            });
            select.value = currentValue;
        }

        function updateDailySummary() {
            const dateFilter = document.getElementById('daily-summary-date').value;
            let records;
            let targetDate;
            
            if (dateFilter) {
                targetDate = dateFilter;
                records = getAgentRecordsByDate(dateFilter);
            } else {
                targetDate = getTargetDate();
                records = getAgentRecordsByDate(targetDate);
            }
            
            const totals = calculateTotals(records, currentAgent, targetDate);
            
            const previousBalance = calculatePreviousBalance(targetDate);
            const remaining = previousBalance + totals.collections + totals.receipts - totals.deposits - totals.expenses - totals.deliveries - totals.failed;
            
            document.getElementById('previous-balance').textContent = Math.round(previousBalance);
            document.getElementById('total-collections').textContent = Math.round(totals.collections);
            document.getElementById('total-deposits').textContent = Math.round(totals.deposits);
            document.getElementById('total-expenses').textContent = Math.round(totals.expenses);
            document.getElementById('total-receipts').textContent = Math.round(totals.receipts);
            document.getElementById('total-deliveries').textContent = Math.round(totals.deliveries);
            document.getElementById('remaining-balance').textContent = Math.round(remaining);
            
            const list = document.getElementById('operations-list');
            if (records.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg">لا توجد عمليات لهذا اليوم</p>';
                return;
            }
            
            // تصنيف العمليات حسب النوع
            const collections = records.filter(r => r.type === 'collection');
            const deposits = records.filter(r => r.type === 'deposit');
            const expenses = records.filter(r => r.type === 'expense');
            const receipts = records.filter(r => r.type === 'receipt');
            const deliveries = records.filter(r => r.type === 'delivery');
            
            let html = '';
            
            // عرض التحصيلات
            if (collections.length > 0) {
                html += `
                    <div class="operations-category">
                        <div class="category-header">
                            <div class="category-icon" style="background: linear-gradient(135deg, var(--success), #059669);">
                                <i class="fas fa-money-bill-wave text-white"></i>
                            </div>
                            <h4 class="category-title">التحصيلات (${collections.length})</h4>
                        </div>
                        <div class="space-y-3">
                            ${collections.map(r => createOperationCard(r)).join('')}
                        </div>
                    </div>
                `;
            }
            
            // عرض الإيداعات
            if (deposits.length > 0) {
                html += `
                    <div class="operations-category">
                        <div class="category-header">
                            <div class="category-icon" style="background: linear-gradient(135deg, var(--primary-light), #2563eb);">
                                <i class="fas fa-university text-white"></i>
                            </div>
                            <h4 class="category-title">الإيداعات (${deposits.length})</h4>
                        </div>
                        <div class="space-y-3">
                            ${deposits.map(r => createOperationCard(r)).join('')}
                        </div>
                    </div>
                `;
            }
            
            // عرض المصروفات
            if (expenses.length > 0) {
                html += `
                    <div class="operations-category">
                        <div class="category-header">
                            <div class="category-icon" style="background: linear-gradient(135deg, var(--danger), #dc2626);">
                                <i class="fas fa-receipt text-white"></i>
                            </div>
                            <h4 class="category-title">المصروفات (${expenses.length})</h4>
                        </div>
                        <div class="space-y-3">
                            ${expenses.map(r => createOperationCard(r)).join('')}
                        </div>
                    </div>
                `;
            }
            
            // عرض الاستلامات
            if (receipts.length > 0) {
                html += `
                    <div class="operations-category">
                        <div class="category-header">
                            <div class="category-icon" style="background: linear-gradient(135deg, var(--purple), #7c3aed);">
                                <i class="fas fa-download text-white"></i>
                            </div>
                            <h4 class="category-title">الاستلامات (${receipts.length})</h4>
                        </div>
                        <div class="space-y-3">
                            ${receipts.map(r => createOperationCard(r)).join('')}
                        </div>
                    </div>
                `;
            }
            
            // عرض التسليمات
            if (deliveries.length > 0) {
                html += `
                    <div class="operations-category">
                        <div class="category-header">
                            <div class="category-icon" style="background: linear-gradient(135deg, var(--warning), #d97706);">
                                <i class="fas fa-upload text-white"></i>
                            </div>
                            <h4 class="category-title">التسليمات (${deliveries.length})</h4>
                        </div>
                        <div class="space-y-3">
                            ${deliveries.map(r => createOperationCard(r)).join('')}
                        </div>
                    </div>
                `;
            }
            
            list.innerHTML = html;
        }

        function updateAllOperations() {
            const agentFilter = document.getElementById('filter-agent').value;
            const typeFilter = document.getElementById('filter-type').value;
            const dateFilter = document.getElementById('filter-date').value;
            
            let filtered = allRecords.filter(r => !r.is_bank_account && !r.is_debtor_customer && !r.is_failed_deposit);
            
            if (agentFilter) {
                filtered = filtered.filter(r => r.agent_name === agentFilter);
            }
            
            if (typeFilter) {
                filtered = filtered.filter(r => r.type === typeFilter);
            }
            
            if (dateFilter) {
                filtered = filtered.filter(r => r.date === dateFilter);
            }
            
            const list = document.getElementById('all-operations-list');
            if (filtered.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg">لا توجد عمليات</p>';
                return;
            }
            
            filtered.sort((a, b) => {
                const dateCompare = b.date.localeCompare(a.date);
                if (dateCompare !== 0) return dateCompare;
                return b.time.localeCompare(a.time);
            });
            
            list.innerHTML = filtered.map(r => createOperationCard(r, true)).join('');
        }

        function createOperationCard(record, showAgent = false) {
            const typeLabels = {
                collection: '💰 تحصيل',
                deposit: '🏦 إيداع',
                expense: '💸 مصروف',
                receipt: '📥 استلام',
                delivery: '📤 تسليم'
            };
            
            const typeColors = {
                collection: 'from-green-500 to-emerald-600',
                deposit: 'from-blue-500 to-blue-600',
                expense: 'from-red-500 to-red-600',
                receipt: 'from-purple-500 to-purple-600',
                delivery: 'from-orange-500 to-orange-600'
            };
            
            let details = '';
            if (record.type === 'collection') {
                details = `${record.collection_type}`;
                if (record.collection_type !== 'سحب من بطاقة' && record.customer_name) {
                    details += ` - ${record.customer_name}`;
                }
                if (record.bank_account) {
                    details += ` - ${record.bank_account}`;
                }
            } else if (record.type === 'deposit') {
                details = record.bank_account;
            } else if (record.type === 'expense') {
                details = `${record.expense_type}${record.expense_details ? ' - ' + record.expense_details : ''}`;
            } else if (record.type === 'receipt') {
                details = `${record.receipt_type} - ${record.received_from}`;
            } else if (record.type === 'delivery') {
                details = `${record.delivery_type} - ${record.delivered_to}`;
            }
            
            return `
                <div class="operation-card glass-card p-4 responsive-operation-card">
                    <div class="flex items-center gap-3 flex-1 w-full">
                        <div class="icon-circle bg-gradient-to-br ${typeColors[record.type]}">
                            <span class="text-white">${typeLabels[record.type].charAt(0)}</span>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-blue-900">${typeLabels[record.type] || record.type}</p>
                            <p class="text-sm text-gray-600 mt-1">${details}</p>
                            ${showAgent ? `<p class="text-xs text-blue-600 mt-1">المندوب: ${record.agent_name}</p>` : ''}
                            <p class="text-xs text-gray-500 mt-1">${record.date} - ${formatTime(record.time)}</p>
                        </div>
                    </div>
                    <div class="text-left w-full">
                        <p class="text-xl font-bold text-blue-700">${Math.round(record.amount)}</p>
                        <div class="flex gap-2 mt-2">
                            <button onclick="window.editOperation('${record.id}')" class="text-blue-600 hover:scale-125 transition" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="window.deleteRecord('${record.id}')" class="text-red-600 hover:scale-125 transition" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button onclick="window.shareRecord('${record.id}')" class="text-green-600 hover:scale-125 transition" title="مشاركة">
                                <i class="fas fa-share"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateBankAccountsList() {
            const dateFilter = document.getElementById('bank-accounts-date').value;
            const targetDate = dateFilter || getTargetDate();
            const banks = allRecords.filter(r => r.is_bank_account);
            const list = document.getElementById('bank-accounts-list');
            
            if (banks.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg col-span-full">لا توجد حسابات بنكية</p>';
                return;
            }
            
            list.innerHTML = banks.map(bank => {
                const totalDeposits = getTotalDepositsForBank(bank.bank_account, targetDate);
                const totalWithdrawals = getTotalWithdrawalsForBank(bank.bank_account, targetDate);
                const totalActivity = totalDeposits + totalWithdrawals;
                const percentage = (totalDeposits / bank.financial_ceiling) * 100;
                const isAgent = userType === 'agent';
                
                // الحصول على آخر 5 إيداعات لهذا الحساب البنكي
                const lastDeposits = allRecords
                    .filter(r => r.type === 'deposit' && r.bank_account === bank.bank_account && r.date === targetDate)
                    .sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time))
                    .slice(0, 5);
                
                return `
                    <div class="glass-card p-5">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="icon-circle" style="background: linear-gradient(135deg, var(--primary-light), #2563eb);">
                                <i class="fas fa-university text-white"></i>
                            </div>
                            <h4 class="text-lg font-bold text-blue-900">${bank.bank_account}</h4>
                        </div>
                        <div class="space-y-2 text-sm">
                            <p><span class="text-gray-600">رقم الحساب:</span> <span class="text-blue-900 font-bold">${bank.account_number}</span></p>
                            ${bank.card_number ? `<p><span class="text-gray-600">رقم البطاقة:</span> <span class="text-blue-900 font-bold">${bank.card_number}</span></p>` : ''}
                            ${bank.card_holder ? `<p><span class="text-gray-600">صاحب البطاقة:</span> <span class="text-blue-900 font-bold">${bank.card_holder}</span></p>` : ''}
                            <p><span class="text-gray-600">السقف المالي:</span> <span class="text-blue-700 font-bold">${Math.round(bank.financial_ceiling)}</span></p>
                            <p><span class="text-gray-600">إجمالي الإيداعات:</span> <span class="text-blue-600 font-bold">${Math.round(totalDeposits)}</span></p>
                            <p><span class="text-gray-600">إجمالي السحوبات:</span> <span class="text-purple-600 font-bold">${Math.round(totalWithdrawals)}</span></p>
                            <p><span class="text-gray-600">المتبقي من السقف:</span> <span class="text-green-600 font-bold">${Math.round(bank.financial_ceiling - totalDeposits)}</span></p>
                        </div>
                        <div class="mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="progress-bar h-3 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                            <p class="text-sm text-center mt-1 font-bold text-gray-700">${Math.round(percentage)}%</p>
                        </div>
                        
                        <!-- عرض آخر 5 إيداعات -->
                        ${lastDeposits.length > 0 ? `
                            <div class="last-deposits">
                                <h5 class="font-bold text-blue-900 mb-2">آخر ${lastDeposits.length} إيداع:</h5>
                                ${lastDeposits.map(deposit => `
                                    <div class="deposit-item">
                                        <div>
                                            <span class="font-medium">${deposit.agent_name}</span>
                                            <span class="text-xs text-gray-500"> - ${formatTime(deposit.time)}</span>
                                        </div>
                                        <span class="font-bold text-blue-700">${Math.round(deposit.amount)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="flex gap-2 mt-4">
                            ${!isAgent ? `
                                <button onclick="window.editBankAccountRecord('${bank.id}')" class="btn-secondary flex-1 text-white py-2 rounded-xl text-sm flex items-center justify-center">
                                    <i class="fas fa-edit ml-1"></i> تعديل
                                </button>
                                <button onclick="window.deleteRecord('${bank.id}')" class="btn-secondary flex-1 text-white py-2 rounded-xl text-sm flex items-center justify-center">
                                    <i class="fas fa-trash ml-1"></i> حذف
                                </button>
                            ` : ''}
                            <button onclick="window.shareBankReport('${bank.bank_account}')" class="btn-primary ${isAgent ? 'w-full' : 'flex-1'} text-white py-2 rounded-xl text-sm flex items-center justify-center">
                                <i class="fas fa-share ml-1"></i> مشاركة
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateDebtorsList() {
            const debtors = allRecords.filter(r => r.is_debtor_customer);
            const list = document.getElementById('debtors-list');
            const listKhamis = document.getElementById('debtors-list-khamis');
            const listDharan = document.getElementById('debtors-list-dharan');
            const listOther = document.getElementById('debtors-list-other');
            const isAgent = userType === 'agent';
            
            // تصنيف العملاء حسب المنطقة
            const debtorsKhamis = debtors.filter(d => d.customer_region === 'khamis');
            const debtorsDharan = debtors.filter(d => d.customer_region === 'dharan');
            const debtorsOther = debtors.filter(d => d.customer_region === 'other');
            
            if (debtors.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg">لا توجد ديون مسجلة</p>';
                listKhamis.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg">لا توجد ديون لعملاء خميس مشيط</p>';
                listDharan.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg">لا توجد ديون لعملاء ظهران الجنوب</p>';
                listOther.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg">لا توجد ديون لعملاء باقي المناطق</p>';
                return;
            }
            
            // تحديث جميع القوائم
            list.innerHTML = debtors.map(debtor => createDebtorCard(debtor, isAgent)).join('');
            listKhamis.innerHTML = debtorsKhamis.map(debtor => createDebtorCard(debtor, isAgent)).join('');
            listDharan.innerHTML = debtorsDharan.map(debtor => createDebtorCard(debtor, isAgent)).join('');
            listOther.innerHTML = debtorsOther.map(debtor => createDebtorCard(debtor, isAgent)).join('');
        }

        function createDebtorCard(debtor, isAgent) {
            const regionLabels = {
                'khamis': 'خميس مشيط',
                'dharan': 'ظهران الجنوب',
                'other': 'باقي المناطق'
            };
            
            // حساب الرصيد المستخلص (مجموع التحصيلات لهذا العميل)
            const collectionsForCustomer = allRecords.filter(r => 
                r.type === 'collection' && 
                r.customer_name === debtor.customer_name &&
                !r.is_failed_deposit
            );
            const collectedAmount = collectionsForCustomer.reduce((sum, r) => sum + (r.amount || 0), 0);
            
            const remainingDebt = debtor.customer_debt - collectedAmount;
            
            return `
                <div class="operation-card glass-card p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <div class="icon-circle" style="background: linear-gradient(135deg, var(--warning), #d97706);">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <p class="font-bold text-blue-900">${debtor.customer_name}</p>
                                <p class="text-sm text-gray-600 mt-1">المنطقة: ${regionLabels[debtor.customer_region] || 'غير محدد'}</p>
                            </div>
                        </div>
                        ${!isAgent ? `
                            <div class="flex gap-2">
                                <button onclick="window.editDebtorRecord('${debtor.id}')" class="text-blue-600 text-xl hover:scale-125 transition" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="window.deleteRecord('${debtor.id}')" class="text-red-600 text-xl hover:scale-125 transition" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="debtor-stats">
                        <div class="debtor-stat-item">
                            <div class="debtor-stat-label">الرصيد المستحق</div>
                            <div class="debtor-stat-value debt-due">${Math.round(debtor.customer_debt)}</div>
                        </div>
                        <div class="debtor-stat-item">
                            <div class="debtor-stat-label">الرصيد المستخلص</div>
                            <div class="debtor-stat-value debt-collected">${Math.round(collectedAmount)}</div>
                        </div>
                        <div class="debtor-stat-item">
                            <div class="debtor-stat-label">المبلغ المتبقي</div>
                            <div class="debtor-stat-value debt-remaining">${Math.round(remainingDebt)}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateFailedDepositsList() {
            const failed = allRecords.filter(r => r.is_failed_deposit);
            const list = document.getElementById('failed-deposits-list');
            
            if (failed.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg">لا توجد عمليات فاشلة</p>';
                return;
            }
            
            list.innerHTML = failed.map(f => `
                <div class="operation-card glass-card p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <div class="icon-circle" style="background: linear-gradient(135deg, var(--danger), #dc2626);">
                                <i class="fas fa-times text-white"></i>
                            </div>
                            <p class="font-bold text-red-600">عملية إيداع فاشلة</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.shareRecord('${f.id}')" class="text-green-600 hover:scale-125 transition">
                                <i class="fas fa-share"></i>
                            </button>
                            <button onclick="window.deleteRecord('${f.id}')" class="text-red-600 hover:scale-125 transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                        <p><span class="text-gray-600">الحساب:</span> <span class="text-blue-900 font-bold">${f.bank_account}</span></p>
                        <p><span class="text-gray-600">المبلغ:</span> <span class="text-red-600 font-bold">${Math.round(f.amount)}</span></p>
                        <p><span class="text-gray-600">رقم الحساب:</span> <span class="text-blue-900 font-bold">${f.account_number}</span></p>
                        <p><span class="text-gray-600">الفرع:</span> <span class="text-blue-900 font-bold">${f.branch_number || '-'}</span></p>
                        <p><span class="text-gray-600">التاريخ:</span> <span class="text-blue-900 font-bold">${f.date}</span></p>
                        <p><span class="text-gray-600">الوقت:</span> <span class="text-blue-900 font-bold">${formatTime(f.time)}</span></p>
                    </div>
                </div>
            `).join('');
        }

        function updateDashboard() {
            const dateFilter = document.getElementById('dashboard-date').value;
            let todayRecords;
            let targetDate;
            
            if (dateFilter) {
                targetDate = dateFilter;
                todayRecords = getRecordsByDate(dateFilter);
            } else {
                targetDate = getTargetDate();
                todayRecords = getRecordsByDate(targetDate);
            }
            
            const totals = calculateTotals(todayRecords, null, targetDate);
            
            document.getElementById('dash-total-collections').textContent = Math.round(totals.collections);
            document.getElementById('dash-total-deposits').textContent = Math.round(totals.deposits);
            document.getElementById('dash-total-expenses').textContent = Math.round(totals.expenses);
            
            const agents = [...new Set(todayRecords.map(r => r.agent_name))];
            document.getElementById('dash-agents-count').textContent = agents.length;
            
            const performanceDiv = document.getElementById('agents-performance');
            if (agents.length === 0) {
                performanceDiv.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg">لا توجد بيانات</p>';
                return;
            }
            
            performanceDiv.innerHTML = agents.map(agent => {
                const agentRecords = todayRecords.filter(r => r.agent_name === agent);
                const agentTotals = calculateTotals(agentRecords, agent, targetDate);
                
                return `
                    <div class="glass-card p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="icon-circle" style="background: linear-gradient(135deg, var(--purple), #7c3aed);">
                                <i class="fas fa-user-tie text-white"></i>
                            </div>
                            <p class="font-bold text-blue-900">${agent}</p>
                        </div>
                        <div class="grid grid-cols-3 gap-3 text-sm">
                            <div>
                                <p class="text-gray-600">التحصيلات</p>
                                <p class="font-bold text-xl text-green-600 mt-1">${Math.round(agentTotals.collections)}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">الإيداعات</p>
                                <p class="font-bold text-xl text-blue-600 mt-1">${Math.round(agentTotals.deposits)}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">المصروفات</p>
                                <p class="font-bold text-xl text-red-600 mt-1">${Math.round(agentTotals.expenses)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAgentsList() {
            const dateFilter = document.getElementById('agents-date').value;
            let todayRecords;
            let targetDate;
            
            if (dateFilter) {
                targetDate = dateFilter;
                todayRecords = getRecordsByDate(dateFilter);
            } else {
                targetDate = getTargetDate();
                todayRecords = getRecordsByDate(targetDate);
            }
            
            const agents = [...new Set(todayRecords.map(r => r.agent_name))];
            
            const list = document.getElementById('agents-list');
            if (agents.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg">لا توجد بيانات</p>';
                return;
            }
            
            list.innerHTML = agents.map(agent => {
                const agentRecords = todayRecords.filter(r => r.agent_name === agent);
                const totals = calculateTotals(agentRecords, agent, targetDate);
                const previousBalance = parseInt(localStorage.getItem(`previousBalance_${agent}_${targetDate}`) || 0);
                const remaining = previousBalance + totals.collections + totals.receipts - totals.deposits - totals.expenses - totals.deliveries - totals.failed;
                
                return `
                    <div class="glass-card p-5">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="icon-circle" style="background: linear-gradient(135deg, var(--purple), #7c3aed); width: 50px; height: 50px;">
                                <i class="fas fa-user-tie text-white"></i>
                            </div>
                            <h4 class="text-xl font-bold text-blue-900">${agent}</h4>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                            <div class="stat-card p-3">
                                <p class="text-gray-600 font-bold">التحصيلات</p>
                                <p class="text-lg font-bold text-green-600 mt-1">${Math.round(totals.collections)}</p>
                            </div>
                            <div class="stat-card p-3">
                                <p class="text-gray-600 font-bold">الإيداعات</p>
                                <p class="text-lg font-bold text-blue-600 mt-1">${Math.round(totals.deposits)}</p>
                            </div>
                            <div class="stat-card p-3">
                                <p class="text-gray-600 font-bold">المصروفات</p>
                                <p class="text-lg font-bold text-red-600 mt-1">${Math.round(totals.expenses)}</p>
                            </div>
                            <div class="stat-card p-3">
                                <p class="text-gray-600 font-bold">الاستلامات</p>
                                <p class="text-lg font-bold text-purple-600 mt-1">${Math.round(totals.receipts)}</p>
                            </div>
                            <div class="stat-card p-3">
                                <p class="text-gray-600 font-bold">التسليمات</p>
                                <p class="text-lg font-bold text-orange-600 mt-1">${Math.round(totals.deliveries)}</p>
                            </div>
                            <div class="stat-card p-3">
                                <p class="text-gray-600 font-bold">المتبقي</p>
                                <p class="text-lg font-bold text-indigo-600 mt-1">${Math.round(remaining)}</p>
                            </div>
                        </div>
                        <button onclick="window.shareAgentReport('${agent}')" class="btn-primary w-full text-white py-2 rounded-xl mt-4 flex items-center justify-center">
                            <i class="fas fa-share ml-2"></i> مشاركة التقرير
                        </button>
                    </div>
                `;
            }).join('');
        }

        // تحسين قوالب المشاركة لتطابق النموذج المطلوب
        function generateOperationShare(record, title) {
            const targetDate = record.date;
            const todayRecords = getAgentRecordsByDate(targetDate);
            const totals = calculateTotals(todayRecords, currentAgent, targetDate);
            const previousBalance = calculatePreviousBalance(targetDate);
            const remaining = previousBalance + totals.collections + totals.receipts - totals.deposits - totals.expenses - totals.deliveries - totals.failed;
            
            let details = '';
            if (record.type === 'collection') {
                details = `▫️ العميل: ${record.customer_name || 'غير محدد'}\n▫️ النوع: ${record.collection_type}`;
                if (record.bank_account) {
                    details += `\n▫️ البطاقة: ${record.bank_account}`;
                }
            } else if (record.type === 'deposit') {
                details = `▫️ الحساب: ${record.bank_account}`;
            } else if (record.type === 'expense') {
                details = `▫️ النوع: ${record.expense_type}`;
                if (record.expense_details) {
                    details += `\n▫️ التفاصيل: ${record.expense_details}`;
                }
            } else if (record.type === 'receipt') {
                details = `▫️ النوع: ${record.receipt_type}\n▫️ ${record.receipt_type === 'مندوب' ? 'اسم المندوب:' : 'اسم الشركة:'} ${record.received_from}`;
            } else if (record.type === 'delivery') {
                details = `▫️ النوع: ${record.delivery_type}\n▫️ اسم المستلم: ${record.delivered_to}`;
            }
            
            return `━━━━━━━━━━━━━━━━━
${title}
━━━━━━━━━━━━━━━━━

${details}
▫️ المبلغ: ${Math.round(record.amount)}
▫️ التاريخ: ${formatDateForShare(record.date, record.time)}
▫️ المندوب: ${record.agent_name}

*💰 المبلغ المتبقي: ${Math.round(remaining)}*`;
        }

        function generateWithdrawalShare(record, totalActivity) {
            return `━━━━━━━━━━━━━━━━━
💳 سحب من بطاقة جديد
━━━━━━━━━━━━━━━━━

▫️ البطاقة: ${record.bank_account}
▫️ المبلغ: ${Math.round(record.amount)}
▫️ العميل: ${record.customer_name || 'غير محدد'}
▫️ التاريخ: ${formatDateForShare(record.date, record.time)}
▫️ المندوب: ${record.agent_name}

📊 إجمالي نشاط البطاقة اليوم: ${Math.round(totalActivity)}`;
        }

        function generateDepositShare(record, remaining) {
            const targetDate = record.date;
            const todayRecords = getAgentRecordsByDate(targetDate);
            const totals = calculateTotals(todayRecords, currentAgent, targetDate);
            const previousBalance = calculatePreviousBalance(targetDate);
            const totalRemaining = previousBalance + totals.collections + totals.receipts - totals.deposits - totals.expenses - totals.deliveries - totals.failed;
            
            return `━━━━━━━━━━━━━━━━━
*🏦 إيداع بنكي جديد*
━━━━━━━━━━━━━━━━━

▫️ الحساب: ${record.bank_account}
▫️ المبلغ: ${Math.round(record.amount)}
▫️ التاريخ: ${formatDateForShare(record.date, record.time)}
▫️ المندوب: ${record.agent_name}
💳 المتبقي من السقف: ${Math.round(remaining)}

*💰 المبلغ المتبقي :  ${Math.round(totalRemaining)}*`;
        }

        function generateReceiptShare(record) {
            return `━━━━━━━━━━━━━━━━━
📥 استلام نقدي جديد
━━━━━━━━━━━━━━━━━

▫️ نوع الاستلام: ${record.receipt_type}
▫️ ${record.receipt_type === 'مندوب' ? 'اسم المندوب:' : 'اسم الشركة:'} ${record.received_from}
▫️ المبلغ: ${Math.round(record.amount)}
▫️ التاريخ: ${formatDateForShare(record.date, record.time)}
▫️ المندوب: ${record.agent_name}`;
        }

        function generateDeliveryShare(record) {
            return `━━━━━━━━━━━━━━━━━
📤 تسليم نقدي جديد
━━━━━━━━━━━━━━━━━

▫️ نوع التسليم: ${record.delivery_type}
▫️ اسم المستلم: ${record.delivered_to}
▫️ المبلغ: ${Math.round(record.amount)}
▫️ التاريخ: ${formatDateForShare(record.date, record.time)}
▫️ المندوب: ${record.agent_name}`;
        }

        function generateSummaryReport() {
            const targetDate = getTargetDate();
            const todayRecords = getAgentRecordsByDate(targetDate);
            const totals = calculateTotals(todayRecords, currentAgent, targetDate);
            const previousBalance = calculatePreviousBalance(targetDate);
            const remaining = previousBalance + totals.collections + totals.receipts - totals.deposits - totals.expenses - totals.deliveries - totals.failed;
            
            const dateObj = new Date(targetDate);
            const dateStr = `${dateObj.getDate()}/${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;
            
            return `━━━━━━━━━━━━━━━━━
📊 ملخص اليوم
━━━━━━━━━━━━━━━━━

المندوب: ${currentAgent}
التاريخ: ${dateStr}

💰 التحصيلات: ${Math.round(totals.collections)}
🏦 الإيداعات: ${Math.round(totals.deposits)}
💸 المصروفات: ${Math.round(totals.expenses)}
📥 الاستلامات: ${Math.round(totals.receipts)}
📤 التسليمات: ${Math.round(totals.deliveries)}
❌ الإيداعات الفاشلة: ${Math.round(totals.failed)}

💵 المبلغ المتبقي: ${Math.round(remaining)}`;
        }

        function generateDetailedReport() {
            const targetDate = getTargetDate();
            const todayRecords = getAgentRecordsByDate(targetDate);
            const totals = calculateTotals(todayRecords, currentAgent, targetDate);
            const previousBalance = calculatePreviousBalance(targetDate);
            const remaining = previousBalance + totals.collections + totals.receipts - totals.deposits - totals.expenses - totals.deliveries - totals.failed;
            
            const dateObj = new Date(targetDate);
            const dateStr = `${dateObj.getDate()}/${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;
            
            let report = `━━━━━━━━━━━━━━━━━
📋 التقرير التفصيلي
━━━━━━━━━━━━━━━━━

المندوب: ${currentAgent}
التاريخ: ${dateStr}

`;

            const collections = todayRecords.filter(r => r.type === 'collection');
            if (collections.length > 0) {
                report += `💰 التحصيلات (${collections.length}):\n`;
                collections.forEach((r, i) => {
                    report += `${i + 1}. ${r.customer_name || 'غير محدد'} - ${r.collection_type}: ${Math.round(r.amount)}`;
                    if (r.bank_account) report += ` - ${r.bank_account}`;
                    report += `\n`;
                });
                report += `\n`;
            }

            const deposits = todayRecords.filter(r => r.type === 'deposit');
            if (deposits.length > 0) {
                report += `🏦 الإيداعات (${deposits.length}):\n`;
                deposits.forEach((r, i) => {
                    report += `${i + 1}. ${r.bank_account}: ${Math.round(r.amount)}\n`;
                });
                report += `\n`;
            }

            const expenses = todayRecords.filter(r => r.type === 'expense');
            if (expenses.length > 0) {
                report += `💸 المصروفات (${expenses.length}):\n`;
                expenses.forEach((r, i) => {
                    report += `${i + 1}. ${r.expense_type}: ${Math.round(r.amount)}\n`;
                });
                report += `\n`;
            }

            const receipts = todayRecords.filter(r => r.type === 'receipt');
            if (receipts.length > 0) {
                report += `📥 الاستلامات (${receipts.length}):\n`;
                receipts.forEach((r, i) => {
                    report += `${i + 1}. ${r.receipt_type} - ${r.received_from}: ${Math.round(r.amount)}\n`;
                });
                report += `\n`;
            }

            const deliveries = todayRecords.filter(r => r.type === 'delivery');
            if (deliveries.length > 0) {
                report += `📤 التسليمات (${deliveries.length}):\n`;
                deliveries.forEach((r, i) => {
                    report += `${i + 1}. ${r.delivery_type} - ${r.delivered_to}: ${Math.round(r.amount)}\n`;
                });
                report += `\n`;
            }

            // الإيداعات الفاشلة
            const failedDeposits = allRecords.filter(r => 
                r.is_failed_deposit && 
                r.date === targetDate && 
                r.agent_name === currentAgent
            );
            
            if (failedDeposits.length > 0) {
                report += `❌ الإيداعات الفاشلة (${failedDeposits.length}):\n`;
                failedDeposits.forEach((r, i) => {
                    report += `${i + 1}. ${r.bank_account}: ${Math.round(r.amount)}\n`;
                });
                report += `\n`;
            }

            report += `━━━━━━━━━━━━━━━━━
📊 الإجماليات:
💰 التحصيلات: ${Math.round(totals.collections)}
🏦 الإيداعات: ${Math.round(totals.deposits)}
💸 المصروفات: ${Math.round(totals.expenses)}
📥 الاستلامات: ${Math.round(totals.receipts)}
📤 التسليمات: ${Math.round(totals.deliveries)}
❌ الإيداعات الفاشلة: ${Math.round(totals.failed)}

💵 المبلغ المتبقي: ${Math.round(remaining)}`;

            return report;
        }

        window.editOperation = function(id) {
            const record = allRecords.find(r => r.id === id);
            if (record) {
                enableEditOperation(record);
            }
        };

        window.editBankAccountRecord = function(id) {
            const bank = allRecords.find(r => r.id === id);
            if (bank) {
                enableEditBankAccount(bank);
            }
        };

        window.editDebtorRecord = function(id) {
            const debtor = allRecords.find(r => r.id === id);
            if (debtor) {
                enableEditDebtor(debtor);
            }
        };

        window.shareRecord = function(id) {
            const record = allRecords.find(r => r.id === id);
            if (!record) return;
            
            if (record.is_failed_deposit) {
                const shareText = `━━━━━━━━━━━━━━━━━
❌ عملية إيداع فاشلة
━━━━━━━━━━━━━━━━━

▫️ الحساب: ${record.bank_account}
▫️ رقم الحساب: ${record.account_number}
▫️ المبلغ: ${Math.round(record.amount)}
▫️ الفرع: ${record.branch_number || '-'}
▫️ رقم الجهاز: ${record.device_number || '-'}
▫️ العنوان: ${record.branch_address || '-'}
▫️ رقم البطاقة: ${record.card_number || '-'}
▫️ صاحب البطاقة: ${record.card_holder || '-'}
▫️ رمز البطاقة: ${record.card_code || '-'}
▫️ التاريخ: ${formatDateForShare(record.date, record.time)}
▫️ المندوب: ${record.agent_name}`;
                showShareModal(shareText);
            } else if (record.type === 'collection' && record.collection_type === 'سحب من بطاقة') {
                const totalActivity = getTotalBankActivity(record.bank_account, record.date);
                showShareModal(generateWithdrawalShare(record, totalActivity));
            } else if (record.type === 'receipt') {
                showShareModal(generateReceiptShare(record));
            } else if (record.type === 'delivery') {
                showShareModal(generateDeliveryShare(record));
            } else {
                const titles = {
                    collection: '*💰 عملية تحصيل جديدة*',
                    deposit: '*🏦 إيداع بنكي جديد*',
                    expense: '💸 مصروف جديد',
                    receipt: '📥 استلام جديد',
                    delivery: '📤 تسليم جديد'
                };
                showShareModal(generateOperationShare(record, titles[record.type] || 'عملية جديدة'));
            }
        };

        window.shareBankReport = function(bankAccount) {
            const dateFilter = document.getElementById('bank-accounts-date').value;
            const targetDate = dateFilter || getTargetDate();
            
            const deposits = allRecords.filter(r => 
                r.type === 'deposit' && 
                r.bank_account === bankAccount && 
                r.date === targetDate
            );
            
            const withdrawals = allRecords.filter(r => 
                r.type === 'collection' && 
                r.collection_type === 'سحب من بطاقة' && 
                r.bank_account === bankAccount && 
                r.date === targetDate
            );
            
            const bank = allRecords.find(r => r.is_bank_account && r.bank_account === bankAccount);
            const totalDeposits = deposits.reduce((sum, d) => sum + d.amount, 0);
            const totalWithdrawals = withdrawals.reduce((sum, w) => sum + w.amount, 0);
            
            const dateObj = new Date(targetDate);
            const dateStr = `${dateObj.getDate()}/${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;
            
            let report = `━━━━━━━━━━━━━━━━━
🏦 تقرير الحساب البنكي
━━━━━━━━━━━━━━━━━

التاريخ: ${dateStr}

▫️ اسم الحساب: ${bankAccount}
▫️ رقم الحساب: ${bank.account_number}
▫️ رقم البطاقة: ${bank.card_number || 'غير محدد'}
▫️ صاحب البطاقة: ${bank.card_holder || 'غير محدد'}
▫️ السقف المالي: ${Math.round(bank.financial_ceiling)}

━━━━━━━━━━━━━━━━━

`;

            if (deposits.length > 0) {
                report += `📋 الإيداعات (${deposits.length}):\n`;
                deposits.forEach((d, i) => {
                    report += `${i + 1}. ${d.agent_name} : ${Math.round(d.amount)} - ${formatTime(d.time)}\n`;
                });
                report += `\n`;
            } else {
                report += `📋 الإيداعات (0):\nلا توجد إيداعات\n\n`;
            }

            if (withdrawals.length > 0) {
                report += `📋 السحوبات (${withdrawals.length}):\n`;
                withdrawals.forEach((w, i) => {
                    report += `${i + 1}. ${w.agent_name} : ${Math.round(w.amount)} - ${formatTime(w.time)}\n`;
                });
                report += `\n`;
            } else {
                report += `📋 السحوبات (0):\nلا توجد سحوبات\n\n`;
            }

            report += `━━━━━━━━━━━━━━━━━
💰 إجمالي الإيداعات: ${Math.round(totalDeposits)}
💳 إجمالي السحوبات: ${Math.round(totalWithdrawals)}
💵 المتبقي من السقف: ${Math.round(bank.financial_ceiling - totalDeposits)}`;

            showShareModal(report);
        };

        window.shareAgentReport = function(agentName) {
            const dateFilter = document.getElementById('agents-date').value;
            let targetDate;
            
            if (dateFilter) {
                targetDate = dateFilter;
            } else {
                targetDate = getTargetDate();
            }
            
            const agentRecords = allRecords.filter(r => 
                !r.is_bank_account && 
                !r.is_debtor_customer && 
                !r.is_failed_deposit &&
                r.agent_name === agentName &&
                r.date === targetDate
            );
            
            const totals = calculateTotals(agentRecords, agentName, targetDate);
            const previousBalance = parseInt(localStorage.getItem(`previousBalance_${agentName}_${targetDate}`) || 0);
            const remaining = previousBalance + totals.collections + totals.receipts - totals.deposits - totals.expenses - totals.deliveries - totals.failed;
            
            const dateObj = new Date(targetDate);
            const dateStr = `${dateObj.getDate()}/${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;
            
            let report = `━━━━━━━━━━━━━━━━━
👤 تقرير أداء المندوب
━━━━━━━━━━━━━━━━━

▫️ المندوب: ${agentName}
▫️ التاريخ: ${dateStr}

📊 إحصائيات اليوم:
💰 التحصيلات: ${Math.round(totals.collections)}
🏦 الإيداعات: ${Math.round(totals.deposits)}
💸 المصروفات: ${Math.round(totals.expenses)}
📥 الاستلامات: ${Math.round(totals.receipts)}
📤 التسليمات: ${Math.round(totals.deliveries)}
❌ الإيداعات الفاشلة: ${Math.round(totals.failed)}
💵 الرصيد السابق: ${Math.round(previousBalance)}
💎 المبلغ المتبقي: ${Math.round(remaining)}

`;

            // تفاصيل العمليات
            const collections = agentRecords.filter(r => r.type === 'collection');
            if (collections.length > 0) {
                report += `💰 التحصيلات (${collections.length}):\n`;
                collections.forEach((r, i) => {
                    report += `${i + 1}. ${r.customer_name || 'غير محدد'} - ${r.collection_type}: ${Math.round(r.amount)}`;
                    if (r.bank_account) report += ` - ${r.bank_account}`;
                    report += `\n`;
                });
                report += `\n`;
            }

            const deposits = agentRecords.filter(r => r.type === 'deposit');
            if (deposits.length > 0) {
                report += `🏦 الإيداعات (${deposits.length}):\n`;
                deposits.forEach((r, i) => {
                    report += `${i + 1}. ${r.bank_account}: ${Math.round(r.amount)}\n`;
                });
                report += `\n`;
            }

            const expenses = agentRecords.filter(r => r.type === 'expense');
            if (expenses.length > 0) {
                report += `💸 المصروفات (${expenses.length}):\n`;
                expenses.forEach((r, i) => {
                    report += `${i + 1}. ${r.expense_type}: ${Math.round(r.amount)}`;
                    if (r.expense_details) report += ` - ${r.expense_details}`;
                    report += `\n`;
                });
                report += `\n`;
            }

            const receipts = agentRecords.filter(r => r.type === 'receipt');
            if (receipts.length > 0) {
                report += `📥 الاستلامات (${receipts.length}):\n`;
                receipts.forEach((r, i) => {
                    report += `${i + 1}. ${r.receipt_type} - ${r.received_from}: ${Math.round(r.amount)}\n`;
                });
                report += `\n`;
            }

            const deliveries = agentRecords.filter(r => r.type === 'delivery');
            if (deliveries.length > 0) {
                report += `📤 التسليمات (${deliveries.length}):\n`;
                deliveries.forEach((r, i) => {
                    report += `${i + 1}. ${r.delivery_type} - ${r.delivered_to}: ${Math.round(r.amount)}\n`;
                });
            }

            showShareModal(report);
        };

        window.deleteRecord = function(id) {
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed bottom-20 right-4 glass-card p-4 z-50 shadow-2xl max-w-xs';
            confirmDiv.innerHTML = `
                <p class="font-bold mb-3 text-blue-900">هل أنت متأكد من الحذف؟</p>
                <div class="flex gap-2">
                    <button id="confirm-delete" class="bg-red-600 text-white px-4 py-2 rounded-xl text-sm font-bold flex-1">نعم، احذف</button>
                    <button id="cancel-delete" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-xl text-sm font-bold flex-1 hover:bg-gray-400 transition">إلغاء</button>
                </div>
            `;
            document.body.appendChild(confirmDiv);
            
            document.getElementById('confirm-delete').addEventListener('click', async () => {
                try {
                    const recordRef = ref(database, 'records/' + id);
                    await remove(recordRef);
                    showToast('تم الحذف بنجاح ✅');
                    confirmDiv.remove();
                } catch (error) {
                    showToast('فشل في الحذف: ' + error.message, 'error');
                }
            });
            
            document.getElementById('cancel-delete').addEventListener('click', () => {
                confirmDiv.remove();
            });
        };

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600' : 'bg-gradient-to-r from-green-500 to-emerald-600'}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // تهيئة النظام عند التحميل
        initializeDateFilters();
        checkForNewDay();
    </script>
</body>
</html>
